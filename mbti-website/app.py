import streamlit as st
import time
from collections import Counter
import os

# ==========================================
# 1. 核心配置与自定义样式
# ==========================================

st.set_page_config(
    page_title="Zeuspace 交易员潜能评估系统",
    page_icon="⚡",
    layout="centered",
    initial_sidebar_state="collapsed"
)

# 注入自定义 CSS 以优化 UI (暗黑流体风格 + 高对比度修正)
st.markdown("""
<style>
    /* 全局背景与字体 */
    .stApp {
        background-color: #0f172a;
        font-family: 'Inter', system-ui, -apple-system, sans-serif;
        color: #e2e8f0;
    }
    
    /* 隐藏 Streamlit 默认元素 */
    #MainMenu {visibility: hidden;}
    footer {visibility: hidden;}
    header {visibility: hidden;}
    
    /* 标题高亮修正 */
    h1, h2, h3 {
        color: #f8fafc !important; /* 强制亮白 */
    }
    p, li {
        color: #cbd5e1;
    }
    
    /* --- [新增] 人格形象图片样式 --- */
    .hero-image-container {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 10px;
        animation: fadeIn 1.5s ease-in-out;
    }
    
    .hero-image-img {
        width: 100%;
        max-width: 350px; /* 限制最大宽度 */
        border-radius: 20px;
        /* 给图片加一个符合流体风格的蓝色光晕 */
        box-shadow: 0 0 30px rgba(59, 130, 246, 0.3); 
        transition: transform 0.3s ease;
    }
    
    .hero-image-img:hover {
        transform: scale(1.02);
        box-shadow: 0 0 40px rgba(59, 130, 246, 0.5);
    }

    @keyframes fadeIn {
        0% { opacity: 0; transform: translateY(20px); }
        100% { opacity: 1; transform: translateY(0); }
    }
    
    /* --- 新增结果页头部样式 --- */
    .result-header-container {
        text-align: center;
        padding: 20px 0 40px 0;
        border-bottom: 1px solid #334155;
        margin-bottom: 30px;
    }
    
    .archetype-badge {
        display: inline-block;
        background: rgba(59, 130, 246, 0.15);
        color: #60a5fa;
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.9em;
        font-weight: 600;
        margin-bottom: 10px;
        border: 1px solid rgba(59, 130, 246, 0.3);
    }

    .main-title-gradient {
        font-size: 2.8em; 
        font-weight: 900; 
        background: linear-gradient(135deg, #fff 0%, #94a3b8 100%); 
        -webkit-background-clip: text; 
        -webkit-text-fill-color: transparent;
        margin: 10px 0 30px 0;
        letter-spacing: -1px;
    }

    /* 4个维度卡片布局 */
    .traits-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
        margin-top: 20px;
    }
            
    /* Tab 样式优化 */
    .stTabs [data-baseweb="tab-list"] {
        gap: 8px;
        background-color: transparent;
        padding-bottom: 0px;
    }
    .stTabs [data-baseweb="tab"] {
        height: 45px;
        background-color: rgba(30, 41, 59, 0.4);
        border-radius: 8px 8px 0 0;
        color: #94a3b8;
        font-weight: 600;
        border: 1px solid #334155;
        border-bottom: none;
        padding: 0 20px;
        flex-grow: 1;
    }
    .stTabs [aria-selected="true"] {
        background-color: #1e293b !important;
        color: #60a5fa !important;
        border-color: #60a5fa !important;
        border-bottom: 1px solid #1e293b !important;
    }
    .stTabs [data-baseweb="tab-panel"] {
        background: #1e293b;
        border: 1px solid #60a5fa;
        border-top: none;
        border-radius: 0 0 12px 12px;
        padding: 20px;
        margin-top: -1px;
    }

    /* 单个字母卡片 */
    .trait-box {
        background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
        border: 1px solid #334155;
        border-radius: 12px;
        padding: 15px 5px;
        text-align: center;
        transition: transform 0.3s;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
    
    .trait-box:hover {
        transform: translateY(-5px);
        border-color: #60a5fa;
    }

    .trait-letter {
        font-size: 2.2em;
        font-weight: 800;
        color: #fff;
        line-height: 1;
        margin-bottom: 5px;
    }
    
    .trait-name {
        color: #94a3b8;
        font-size: 0.8em;
        font-weight: 600;
        margin-bottom: 8px;
        text-transform: uppercase;
    }
    
    .trait-bar {
        width: 40px;
        height: 3px;
        background: #3b82f6;
        border-radius: 2px;
        margin-bottom: 8px;
    }
    
    /* 按钮美化 */
    div.stButton > button {
        background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
        color: #e2e8f0;
        border: 1px solid #334155;
        border-radius: 12px;
        padding: 16px 24px;
        font-size: 16px;
        font-weight: 500;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        width: 100%;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    div.stButton > button:hover {
        border-color: #60a5fa;
        color: #ffffff;
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.2);
    }
    
    /* 主按钮样式 (Primary) */
    div.stButton > button[kind="primary"] {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        border: none;
        color: white;
        font-weight: 700;
    }
    div.stButton > button[kind="primary"]:hover {
        background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
        box-shadow: 0 0 25px rgba(59, 130, 246, 0.6);
    }

    /* 卡片容器 */
    .css-card {
        background: rgba(30, 41, 59, 0.7);
        backdrop-filter: blur(10px);
        border: 1px solid #334155;
        border-radius: 16px;
        padding: 28px;
        margin-bottom: 24px;
        transition: border 0.3s;
    }
    .css-card:hover {
        border-color: #475569;
    }
    
    /* 进度条颜色 */
    .stProgress > div > div > div > div {
        background: linear-gradient(90deg, #3b82f6, #06b6d4);
    }
    
    /* 社交链接样式 (新) */
    .social-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        padding: 12px;
        border-radius: 12px;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.2s;
        margin-bottom: 10px;
    }
    .social-linkedin {
        background-color: #0077b5;
        color: white !important;
        border: 1px solid #0077b5;
    }
    .social-twitter {
        background-color: #000000;
        color: white !important;
        border: 1px solid #333;
    }
    .social-btn:hover {
        opacity: 0.9;
        transform: scale(1.02);
    }
/* ===== Mobile-friendly typography (append at end of your CSS) ===== */
:root{
  --fz-body: 14px;
  --fz-small: 12px;
  --fz-h1: 28px;
  --fz-h2: 18px;
  --fz-h3: 16px;
}

.stApp { font-size: var(--fz-body); }
p, li { font-size: var(--fz-body) !important; line-height: 1.65; }

/* Headings */
h1 { font-size: var(--fz-h1) !important; line-height: 1.15; }
h2 { font-size: var(--fz-h2) !important; line-height: 1.25; }
h3 { font-size: var(--fz-h3) !important; line-height: 1.25; }

/* Streamlit text bits */
.stCaptionContainer, .stCaption, small, .tiny-text {
  font-size: var(--fz-small) !important;
}

/* Buttons */
div.stButton > button { font-size: 14px !important; padding: 12px 16px !important; }

/* Result hero title you set with class */
.main-title-gradient { font-size: 30px !important; }

/* Traits box */
.trait-letter { font-size: 22px !important; }
.trait-name { font-size: 11px !important; }

/* Reduce card padding for mobile */
.css-card { padding: 18px !important; }

/* Responsive overrides */
@media (max-width: 480px){
  :root{
    --fz-body: 13px;
    --fz-small: 11px;
    --fz-h1: 24px;
    --fz-h2: 17px;
    --fz-h3: 15px;
  }
  .traits-grid{ grid-template-columns: repeat(2, 1fr) !important; }
}
</style>
""", unsafe_allow_html=True)

# ==========================================
# 2. 深度人格数据库 (Zeuspace Pro Max 版)
# ==========================================

# 仅保留新的高频交易/Crypto相关题目 (52题)，移除旧题以避免混淆和冗长
RAW_QUESTIONS = [
    # =========================================================
    # 1–20 小白友好（每维 5 题，EI/SN/TF/JP 均衡）
    # =========================================================

    # 1
    {'d': 'EI', 'text': "你刚接触“投资/交易”这件事时，更像是？",
     'a': "喜欢和朋友聊聊市场热度、听不同观点再决定",   # E
     'b': "更愿意自己安静研究，弄明白再行动"},          # I

    {'d': 'SN', 'text': "看到一个产品/公司/赛道被热议，你第一反应更偏向？",
     'a': "先找具体信息：价格、数据、事实、最近发生了什么",   # S
     'b': "先想大方向：它未来可能会怎样、会带来什么改变"},     # N

    {'d': 'TF', 'text': "当你要做一个重要的金钱决定（买/卖/投不投）时，你更依赖？",
     'a': "规则与计算：预算、风险、得失、是否划算",        # T
     'b': "感受与价值：我是否认同它、是否让我安心"},        # F

    {'d': 'JP', 'text': "你做事（包括学习投资）更像哪种节奏？",
     'a': "先制定计划：学什么、看什么、什么时候行动",       # J
     'b': "边学边做：先试试，过程中再调整"},               # P

    # 5
    {'d': 'EI', 'text': "遇到不确定的行情/消息时，你更容易？",
     'a': "去找人讨论，越聊越清晰",                        # E
     'b': "先不说，自己想通再说"},                         # I

    {'d': 'SN', 'text': "你更信任哪类信息？",
     'a': "“现在能验证的”：数据、价格、客观事实",          # S
     'b': "“能解释未来的”：趋势、逻辑、叙事"},             # N

    {'d': 'TF', 'text': "如果一次决定结果不理想，你更在意的是？",
     'a': "我哪里推理错了/规则没做好（方法问题）",          # T
     'b': "我当时的情绪和体验（心态问题）"},               # F

    {'d': 'JP', 'text': "你更喜欢哪种“行动方式”？",
     'a': "明确的步骤：做完 A 再做 B",                      # J
     'b': "开放的选择：先做能做的，其他看情况"},           # P

    # 9
    {'d': 'EI', 'text': "当你学到一个新概念（比如止损/分散/趋势）你更喜欢？",
     'a': "讲给别人听/一起讨论，越讲越会",                 # E
     'b': "自己消化，整理成笔记或体系"},                   # I

    {'d': 'SN', 'text': "你更容易被哪种内容吸引？",
     'a': "例子清楚、步骤明确、能照做",                     # S
     'b': "框架完整、能启发思考、能举一反三"},             # N

    {'d': 'TF', 'text': "别人给你建议时，你更希望对方？",
     'a': "把理由讲清楚：依据是什么、概率是什么",           # T
     'b': "先理解我：我的目标和压力是什么"},               # F

    {'d': 'JP', 'text': "周末/空闲时间，你更偏向？",
     'a': "安排好要做的事，做完更踏实",                     # J
     'b': "随心一点，临时决定做什么"},                     # P

    # 13
    {'d': 'EI', 'text': "当你取得一个小成果（比如赚到/省到一笔）你更倾向？",
     'a': "想分享一下，获得互动和反馈",                     # E
     'b': "自己开心就好，不太想说"},                       # I

    {'d': 'SN', 'text': "你更擅长记住？",
     'a': "具体数字、时间点、细节（例如价格区间）",         # S
     'b': "整体感觉、故事脉络、当时氛围"},                 # N

    {'d': 'TF', 'text': "面对“别人都在买/都在卖”的情况，你更可能？",
     'a': "先判断：对我来说是否符合规则/是否值得跟",        # T
     'b': "会受情绪感染：担心错过或担心落后"},              # F

    {'d': 'JP', 'text': "你对“规则”更像哪一种态度？",
     'a': "规则能让我更稳定，我愿意遵守",                   # J
     'b': "规则是参考，关键看当下情况"},                   # P

    # 17
    {'d': 'EI', 'text': "在一个陌生的学习/社群环境里，你通常？",
     'a': "会主动交流，快速融入",                           # E
     'b': "先观察一阵子，熟悉后再参与"},                   # I

    {'d': 'SN', 'text': "当你看一个走势（不管是股/币/汇/商品）你更先注意？",
     'a': "当前发生了什么：涨跌幅、成交量、关键位置",       # S
     'b': "它可能意味着什么：趋势是否改变、是否进入新阶段"},# N

    {'d': 'TF', 'text': "你更认可哪句话？",
     'a': "“重要的是长期正确的决策过程。”",               # T
     'b': "“重要的是这个过程让我睡得安稳。”"},            # F

    {'d': 'JP', 'text': "如果你今天没按计划学习/执行，你更可能？",
     'a': "不舒服，想尽快补回来",                           # J
     'b': "还好，明天再说"},                                # P


    # =========================================================
    # 21–52 进阶（更市场化/更“交易常识”，依然四维均衡：每维 8 题）
    # =========================================================

    # 21
    {'d': 'EI', 'text': "当市场突然剧烈波动（新闻、黑天鹅）你第一反应更像？",
     'a': "快速去看大家怎么说，综合群体信息判断",           # E
     'b': "先屏蔽噪音，只看价格与数据再决定"},              # I

    {'d': 'SN', 'text': "你更容易相信哪种“信号”？",
     'a': "明确可重复的：支撑/压力、成交量变化、形态确认",   # S
     'b': "结构与节奏：周期位置、情绪拐点、范式切换"},       # N

    {'d': 'TF', 'text': "你更倾向用什么方式评估一笔交易是否值得？",
     'a': "看期望值：胜率×收益 - 败率×亏损（大致也行）",    # T
     'b': "看心理成本：这笔单子会不会让我一直焦虑"},        # F

    {'d': 'JP', 'text': "你更喜欢哪种下单方式？",
     'a': "提前设好条件单/限价单，到点自动执行",            # J
     'b': "先观察盘面，临场决定用市价/手动下单"},           # P

    # 25
    {'d': 'EI', 'text': "学习交易时，你更有效的方式是？",
     'a': "和别人一起练习/复盘，互相纠错",                  # E
     'b': "自己做交易日志，独立迭代"},                      # I

    {'d': 'SN', 'text': "当你看一份分析（研报/帖子/视频），你更在意？",
     'a': "它的证据链：数据来源、图表、事实支撑",            # S
     'b': "它的解释力：能否把“为什么”讲透、能否预测变化"},   # N

    {'d': 'TF', 'text': "遇到“止损被打后立刻反弹”的情况，你更可能？",
     'a': "接受它是成本，复盘规则是否合理",                 # T
     'b': "很懊恼，容易怀疑自己被针对/被戏弄"},             # F

    {'d': 'JP', 'text': "你更倾向怎样提升稳定性？",
     'a': "固定交易时段+固定规则+固定复盘流程",              # J
     'b': "多尝试、多样本、多策略并行，找到适合当下的"},      # P

    # 29
    {'d': 'EI', 'text': "当你对一个机会很有把握时，你更可能？",
     'a': "想找人确认一下/一起行动",                         # E
     'b': "不太需要别人确认，按自己计划执行"},               # I

    {'d': 'SN', 'text': "你更擅长哪种判断？",
     'a': "“现在发生了什么”——把当下信号看清",               # S
     'b': "“接下来可能会怎样”——提前预判剧本"},              # N

    {'d': 'TF', 'text': "你更愿意相信哪种风险观？",
     'a': "风险是可量化可控制的（仓位、止损、回撤）",        # T
     'b': "风险也包括情绪与生活质量（睡眠、压力、人际）"},    # F

    {'d': 'JP', 'text': "你对“策略”更像？",
     'a': "一套必须严格执行的系统",                          # J
     'b': "一套随市场变化不断更新的工具箱"},                 # P

    # 33
    {'d': 'EI', 'text': "复盘一笔交易时，你更倾向？",
     'a': "和别人对照观点，看看自己哪里盲区",               # E
     'b': "自己从头推演，找出最核心的错误点"},             # I

    {'d': 'SN', 'text': "当你看到一个“暴涨故事”你更可能先问？",
     'a': "成交量/流动性在哪？有没有数据支持？",            # S
     'b': "这背后的叙事能不能持续？会不会扩散？"},          # N

    {'d': 'TF', 'text': "别人用很强烈的语气推荐一个机会，你更容易被？",
     'a': "逻辑与数据说服",                                  # T
     'b': "信任感与情绪感染力说服"},                         # F

    {'d': 'JP', 'text': "你更容易在哪种情况下犯错？",
     'a': "计划被打乱、临时变化太多",                        # J
     'b': "机会太多、选择太多、一直想“再等等”"},            # P

    # 37
    {'d': 'EI', 'text': "当你连续盈利时，你更可能？",
     'a': "更想参与讨论/表达观点（信心外放）",              # E
     'b': "更沉默，担心高估自己（信心内收）"},             # I

    {'d': 'SN', 'text': "你更偏好哪种学习内容？",
     'a': "具体技巧：如何设置止损、如何分批、如何做记录",    # S
     'b': "底层规律：为什么会波动、为什么会轮动、为什么会崩"},# N

    {'d': 'TF', 'text': "你更能接受哪种亏损？",
     'a': "按规则止损的小亏（过程正确）",                   # T
     'b': "最后靠扛单回来的亏（过程痛苦但结果没爆）"},      # F

    {'d': 'JP', 'text': "如果你给自己定“交易规则”，你更像？",
     'a': "写成清单/表格，严格打勾执行",                    # J
     'b': "记个大概原则，留出调整空间"},                    # P

    # 41
    {'d': 'EI', 'text': "你更喜欢哪种信息来源？",
     'a': "多来源快输入：社媒、群聊、直播、朋友消息",        # E
     'b': "少来源深输入：几本书/几份数据/几位可靠作者"},      # I

    {'d': 'SN', 'text': "当市场处于长期横盘震荡，你更倾向？",
     'a': "减少主观判断，依赖区间、关键位、条件触发",        # S
     'b': "思考震荡背后的原因，等待“结构变化”的信号"},       # N

    {'d': 'TF', 'text': "你更认可哪种“好决策”？",
     'a': "当下看是合理的：依据充分、风险可控",              # T
     'b': "长期看是舒服的：符合我价值观与生活节奏"},          # F

    {'d': 'JP', 'text': "你更习惯怎样管理仓位？",
     'a': "有固定上限与分配规则（比如永远不满仓）",          # J
     'b': "根据机会强弱灵活加减（但可能波动更大）"},        # P

    # 45
    {'d': 'EI', 'text': "当你想提升自己，你更偏向？",
     'a': "找导师/找社群，拿到反馈更快",                     # E
     'b': "自学+自测，慢但更扎实"},                         # I

    {'d': 'SN', 'text': "关于“基本面/价值”你更像？",
     'a': "看得见的：现金流、财报、用户、供需",              # S
     'b': "看得远的：渗透率、想象空间、未来路径"},           # N

    {'d': 'TF', 'text': "当你与别人观点相反时，你更像？",
     'a': "用逻辑把对方说服（或至少讲清楚）",               # T
     'b': "先考虑关系与氛围，避免让人难堪"},                # F

    {'d': 'JP', 'text': "遇到突发消息，你更可能？",
     'a': "先执行预案：减仓/对冲/观望，按流程来",            # J
     'b': "先感受市场速度：跟随变化快速试错"},               # P

    # 49
    {'d': 'EI', 'text': "你更像哪类“决策者”？",
     'a': "在互动中形成结论：越讨论越清晰",                 # E
     'b': "在独处中形成结论：越安静越清晰"},                # I

    {'d': 'SN', 'text': "你更容易在什么时候“看对”？",
     'a': "信号明确的行情：趋势清晰、关键位有效",            # S
     'b': "故事启动的行情：叙事发酵、预期差形成"},           # N

    {'d': 'TF', 'text': "当一笔交易浮盈后回撤，你更可能？",
     'a': "按规则分批止盈/移动止损，不情绪化",               # T
     'b': "更容易心疼利润回吐，影响后续判断"},               # F

    {'d': 'JP', 'text': "你更适合哪种成长方式？",
     'a': "建立“固定流程”：进场条件、止损规则、复盘模板",     # J
     'b': "建立“探索循环”：小仓试错→总结→再试错→迭代"},      # P
]

# MBTI 字母特质详细定义 (用于结果页头部展示)
# ==========================================
TRAIT_DESCRIPTIONS = {
    'E': {'title': '外向型 (Extraverted)', 'icon': '⚡', 'desc': '从市场热度与群体互动中获取能量', 'tag': '市场共振'},
    'I': {'title': '内向型 (Introverted)', 'icon': '🧘', 'desc': '通过独处复盘与深度思考获取能量', 'tag': '独立思考'},
    'S': {'title': '实感型 (Observant)', 'icon': '📊', 'desc': '关注具体数据、K线形态与既定事实', 'tag': '现实主义'},
    'N': {'title': '直觉型 (Intuitive)', 'icon': '🦄', 'desc': '关注宏观叙事、未来趋势与底层逻辑', 'tag': '理想主义'},
    'T': {'title': '理智型 (Thinking)', 'icon': '⚖️', 'desc': '基于逻辑推演与盈亏比计算做决策', 'tag': '逻辑优先'},
    'F': {'title': '情感型 (Feeling)', 'icon': '❤️', 'desc': '基于市场情绪感知与价值观做决策', 'tag': '情绪感知'},
    'J': {'title': '计划型 (Judging)', 'icon': '📅', 'desc': '偏好详尽的交易计划与严格的纪律', 'tag': '秩序井然'},
    'P': {'title': '展望型 (Prospecting)', 'icon': '🌊', 'desc': '偏好灵活应对盘面变化与随机应变', 'tag': '拥抱波动'}
}

# ==========================================
# 3. 报告模板数据库 (完整 16 型)
# ==========================================
# ==========================================

# 获取脚本所在目录，用于构建正确的相对路径
SCRIPT_DIR = os.path.dirname(os.path.abspath(__file__))

MBTI_IMAGES = {
    'INTJ': os.path.join(SCRIPT_DIR, "static/images/INTJ.png"),
    'ENTJ': os.path.join(SCRIPT_DIR, "static/images/ENTJ.png"),
    'INTP': os.path.join(SCRIPT_DIR, "static/images/INTP.png"),
    'ENTP': os.path.join(SCRIPT_DIR, "static/images/ENTP.png"),
    'INFJ': os.path.join(SCRIPT_DIR, "static/images/INFJ.png"),
    'INFP': os.path.join(SCRIPT_DIR, "static/images/INFP.png"),
    'ENFJ': os.path.join(SCRIPT_DIR, "static/images/ENFJ.png"),
    'ENFP': os.path.join(SCRIPT_DIR, "static/images/ENFP.png"),
    'ISTJ': os.path.join(SCRIPT_DIR, "static/images/ISTJ.png"),
    'ISFJ': os.path.join(SCRIPT_DIR, "static/images/ISFJ.png"),
    'ESTJ': os.path.join(SCRIPT_DIR, "static/images/ESTJ.png"),
    'ESFJ': os.path.join(SCRIPT_DIR, "static/images/ESFJ.png"),
    'ISTP': os.path.join(SCRIPT_DIR, "static/images/ISTP.png"),
    'ISFP': os.path.join(SCRIPT_DIR, "static/images/ISFP.png"),
    'ESTP': os.path.join(SCRIPT_DIR, "static/images/ESTP.png"),
    'ESFP': os.path.join(SCRIPT_DIR, "static/images/ESFP.png"),
}
REPORT_TEMPLATES = {
    'INTJ': {
        'archetype': "全知视角的系统架构师 (The Mastermind)",
        'tagline': "我不预测未来，我构建未来。",
        'cognitive': "INTJ（内向+直觉+理智+判断）是完美主义的逻辑学家。Ni (内倾直觉) 让你总是先看到终局，而 Te (外倾思考) 帮你倒推实现路径。你不仅是在参与市场，更是在解构市场。你对他人的无能和低效率缺乏耐心，通过怀疑一切来建立自己的真理体系。你交易的不是K线，而是市场机制的漏洞。多巴胺对你来说不是来自赚钱，而是来自“我的模型被验证了”那一刻的智力优越感。",
        'blindspot': "过度拟合 (Overfitting) 与上帝情结。你容易陷入“理论完美”，当市场走势与你的模型不符时，你倾向于认为“市场错了/庄家在操纵”，而不是修正模型。你对由于人类非理性情绪（如FOMO）导致的行情嗤之以鼻，这往往让你在Meme狂潮或非理性繁荣中踏空甚至被轧空。",
        'strategy': "左侧埋伏 / Delta Neutral (中性策略) / 跨期套利。",
        'markets': "🔵 链上期权 (Options) | 🔵 宏观对冲基金 | 🔵 复杂的结构化产品",
        'strengths': [
            "上帝视角：极强的宏观大局观，能跨越周期看问题，不被短期噪音干扰",
            "机器之心：能像算法一样冷酷地执行复杂系统，情绪剥离能力极强",
            "逻辑闭环：善于发现市场机制中的逻辑漏洞和低效定价 (Inefficiency)"
        ],
        'weaknesses': [
            "分析瘫痪 (Analysis Paralysis)：试图收集完所有信息再行动，导致错过最佳窗口",
            "厌恶止损：潜意识里认为亏损是对智商的侮辱，容易死扛逻辑已坏的仓位",
            "缺乏社交：忽视“消息面”和“情绪面”的巨大威力，认为那是噪音"
        ],
        'win_condition': "市场处于复杂的宏观转折点，或者需要深度计算才能发现价值的高波动率回归阶段。",
        'loss_trigger': "简单粗暴的情绪化疯牛行情（无需脑子只需胆量），或者你的精密模型遭遇了从未见过的黑天鹅。",
        'desk_setup': "🏛️ 指挥官模式 (The Command Center)：\n- 环境：极度安静，甚至需要降噪耳机。你需要独处来充电，任何打扰都会引发你的愤怒。\n- 配置：至少三屏。左屏宏观数据(Bloomberg)，中屏核心K线，右屏执行终端与日志。\n- 氛围：极简主义，冷色调，没有多余的杂物，一切为了效率。",
        'evolution': {
            'lvl1': "理论巨人：读遍了所有技术指标书，模拟盘无敌，实盘一塌糊涂，容易纸上谈兵。",
            'lvl2': "系统构建者：开发了自己的交易系统，但经常因为“自负”而手动干预系统，处于知行博弈期。",
            'lvl3': "隐形巨鳄：完全信任数学概率，甚至将策略自动化，自己退居幕后做风控，实现“睡后收入”。"
        },
        'tools': ["Python/Pine Script (量化能力)", "Glassnode (链上数据)", "Excel/Notion (深度复盘)"],
        'partners': "⚡ 最佳拍档: ESFP\n你需要一个执行力极强且嗅觉灵敏的猎手，帮你把宏大的理论变成真金白银的操作，弥补你的行动迟缓。"
    },
    'ENTJ': {
        'archetype': "掌控资本的战争指挥官 (The Commander)",
        'tagline': "趋势是我的朋友，而我是趋势的领导者。",
        'cognitive': "ENTJ（外向+直觉+理智+判断）拥有天生的“资本钝感力”。Te (外倾思考) 让你在面对巨额资金波动时心率平稳，只关注效率和结果。Ni (内倾直觉) 让你能敏锐捕捉宏观趋势的起伏。你不仅在交易图表，更是在交易“对手盘的心理”。你拥有极强的执行力和大局观，善于在危机中通过果断的决策获取超额收益，视波动为阶级跃迁的阶梯。",
        'blindspot': "控制幻觉与过度自信。在顺风局中，你容易产生“全靠我能力强”的归因偏差，忽视了运气的成分。强烈的控制欲可能让你试图“抄底”一个正在崩塌的趋势，试图扭转乾坤。你很难听进风控团队或反向数据的反对意见，认为他们格局太小。",
        'strategy': "宏观趋势跟踪 / 大资金配置 / 杠杆做多 (Leveraged Long)。",
        'markets': "🔴 股指期货 (Index Futures) | 🔴 能源/大宗商品 | 🔴 核心资产 (Core Assets)",
        'strengths': [
            "顶级抗压：资金体量越大，你的表现越冷静，天生适合管理大资金",
            "杀伐果断：在关键时刻（如暴跌时）敢于重仓出击，绝不手软",
            "效率至上：善于剔除无效的低盈亏比交易，只做改变命运的大机会"
        ],
        'weaknesses': [
            "杠杆成瘾：过度自信可能导致在一次黑天鹅中因高杠杆爆仓",
            "刚愎自用：难以接受批评，容易在单一方向上死磕到底",
            "忽视细节：可能因为看错一个小数据（如财报细节）而导致宏观判断失效"
        ],
        'win_condition': "史诗级的单边大牛市或大崩盘，需要明确的方向和足够的流动性让你进出。",
        'loss_trigger': "漫长的无序震荡市（垃圾时间），你会因为频繁止损或资金成本过高而心态爆炸。",
        'desk_setup': "🏰 作战室模式 (The War Room)：\n- 环境：宽敞明亮，俯瞰城市景观，象征着掌控感。\n- 配置：巨大的超宽带鱼屏或电视墙，实时滚动着Bloomberg新闻流和全球指数。\n- 氛围：高端、严肃，旁边可能放着雪茄、威士忌或浓缩咖啡。",
        'evolution': {
            'lvl1': "鲁莽赌徒：敢借钱炒币，敢上百倍杠杆，凭运气赚大钱，凭实力亏回去。",
            'lvl2': "资产大鳄：学会了资产配置和对冲，懂得了“留得青山在”，但依然激进。",
            'lvl3': "资本家：不再亲自下场肉搏，而是雇佣交易团队，自己只做战略决策和资源整合。"
        },
        'tools': ["Bloomberg Terminal (宏观)", "Leverage Platforms (杠杆)", "News Feed (情报)"],
        'partners': "🧠 最佳拍档: INTP\n你需要一个逻辑极其严密的人来修补你的盲区，他负责泼冷水，你负责踩油门。"
    },
    'INTP': {
        'archetype': "解构真理的量化极客 (The Logician)",
        'tagline': "在噪音中解码真理，金钱只是副产品。",
        'cognitive': "INTP（内向+直觉+理智+知觉）是天生的系统解构者。Ti (内倾思考) 让你对微观结构有病态般的好奇心，必须搞懂“为什么涨”比“涨了多少”更重要。Ne (外倾直觉) 让你能联想到毫不相关的变量，发现别人看不见的套利路径。你交易的动力往往不是金钱本身，而是为了证明“我解开了这个谜题”。你极其适合在这个算法主导的时代生存。",
        'blindspot': "分析瘫痪 (Analysis Paralysis) 与完美主义。你追求绝对的精确，这在模糊的金融 market 中是致命的。你可能花费数周构建了完美的模型，回测了十年数据，却在需要果断开仓的一瞬间犹豫，试图寻找更多的数据佐证。你容易陷入“纸上谈兵”，在模拟盘中是神，实盘中却因为滑点或网速而手忙脚乱。",
        'strategy': "高频量化 (HFT) / 链上数据分析 / 协议套利 (MEV)。",
        'markets': "🟣 Web3/DeFi 早期矿池 | 🟣 量化策略基金 | 🟣 科技股与合成资产",
        'strengths': [
            "第一性原理：能够直接看穿资产背后的代码和数学逻辑，不被营销话术欺骗",
            "绝对理智：几乎没有情绪波动，非常适合编写和执行冷酷的自动化脚本",
            "持续进化：永远在学习最新的交易技术和理论，技术栈更新速度极快"
        ],
        'weaknesses': [
            "严重的拖延症：完美的策略往往死在实施的前一晚，或者代码写了一半就去研究新的了",
            "缺乏野心：容易满足于智力上的胜利而非账户金额的增长，缺乏做大规模的动力",
            "忽视情绪面：经常因为“这不科学”而做空非理性的暴涨资产，结果被情绪流资金碾压"
        ],
        'win_condition': "市场出现结构性偏差、逻辑漏洞或定价错误 (Inefficiency) 时，比如套利机会。",
        'loss_trigger': "简单粗暴的单边情绪化行情，或者需要极强执行力的人肉高频交易。",
        'desk_setup': "🧪 炼金实验室模式：\n- 环境：看似混乱实则有序的“狗窝”。桌上可能堆着草稿纸、咖啡杯和几本厚厚的编程书。\n- 配置：竖屏写代码，横屏看K线。必备高配置电脑以运行回测。\n- 氛围：硬核极客风，可能会有机械键盘的敲击声作为背景音。",
        'evolution': {
            'lvl1': "民科交易员：沉迷于各种玄学指标和理论，试图寻找“圣杯”，但从不实盘验证。",
            'lvl2': "极客猎手：开始用Python/Excel替代手工，发现独特的Alpha，但在执行上依然犹豫。",
            'lvl3': "算法之神：构建了自动化印钞机，将策略固化为代码，自己躺平看着程序赚钱。"
        },
        'tools': ["Jupyter Notebook (研究)", "Dune Analytics (链上数据)", "Github Copilot"],
        'partners': "🧱 最佳拍档: ESTJ\n你需要一个不仅能听懂你逻辑，还能把你从无休止的思考中拽出来，强制你去落地执行的人。"
    },
    'ENTP': {
        'archetype': "颠覆共识的博弈家 (The Debater)",
        'tagline': "混乱是阶梯，波动是我的游乐场。",
        'cognitive': "ENTP（外向+直觉+理智+知觉）是天生的反向交易者 (Contrarian)。Ne (外倾直觉) 让你对“一致性预期”有着生理性的排斥。哪里有拥挤的交易，你就会出现在它的对立面。Ti (内倾思考) 帮你迅速解构复杂的衍生品结构。你擅长捕捉“黑天鹅”事件，当绝大多数人恐慌抛售时，往往是你进场捡带血筹码的时刻。",
        'blindspot': "为了反对而反对。有时市场共识是正确的（趋势即朋友），过度沉迷于寻找反转（左侧交易）会让你在强单边行情中如同螳臂当车。此外，极度缺乏耐心让你很难拿住一个长达三年的长线单子，经常卖飞。",
        'strategy': "事件驱动 (Event Driven) / 做空波动率 (Short Vol) / 期权策略。",
        'markets': "🟠 衍生品交易 (Derivatives) | 🟠 新兴市场 | 🟠 垃圾债/困境资产",
        'strengths': [
            "逆向思维：总能看到大众忽视的另一面，在恐慌中贪婪",
            "创意无限：善于组合看似不相关的资产进行对冲，创造独特的套利结构",
            "适应力强：无论牛熊，总能找到赚钱的玩法，市场越乱你越兴奋"
        ],
        'weaknesses': [
            "操作过度 (Over-trading)：因为无聊而频繁交易，磨损本金",
            "忽视风控：喜欢在刀尖上跳舞，过度自信能跑得快，容易把自己玩脱",
            "难以坚持：对枯燥的持仓过程感到厌烦，容易在黎明前离场"
        ],
        'win_condition': "市场共识发生剧烈反转的时刻（如利好出尽变利空），或者黑天鹅爆发。",
        'loss_trigger': "漫长的阴跌或温和上涨（慢牛），你会因为无聊而反向操作把自己玩死。",
        'desk_setup': "🎪 极客模式 (The Hacker Setup)：\n- 环境：充满科技感，可能有些乱。多台设备同时运行，甚至可能在手机上完成百万级交易。\n- 配置：多显示器，挂着推特、Discord和期权T型报价图。\n- 氛围：快节奏，旁边可能放着能量饮料，背景放着快节奏音乐。",
        'evolution': {
            'lvl1': "杠精韭菜：总想证明市场错了，喜欢摸顶抄底，结果一直亏钱。",
            'lvl2': "波段游侠：学会了辨别真正的反转信号，胜率大幅提高，成为群里的预言家。",
            'lvl3': "对冲基金经理：利用复杂的期权结构收割市场波动，利用混乱获利 (Antifragile)。"
        },
        'tools': ["Deribit (期权)", "Prediction Markets (预测市场)", "Twitter (情绪监控)"],
        'partners': "🛡️ 最佳拍档: ISFJ\n你需要一个极度保守、甚至有点胆小的管家，帮你守住利润，防止你浪输。"
    },
    'INFJ': {
        'archetype': "洞悉周期的先知 (The Advocate)",
        'tagline': "我看不到K线，我只看到众生的贪婪与恐惧。",
        'cognitive': "INFJ（内向+直觉+情感+判断）拥有近乎玄学的市场感知力。Ni (内倾直觉) 让你不是在看图表，而是在感受图表背后千万个交易者的呼吸。你擅长透过现象看本质，往往能在大周期的极值点（顶部或底部）产生强烈的生理性直觉。Fe (外倾情感) 让你能敏锐捕捉到市场何时过于疯狂（贪婪）或过于绝望（恐惧），你是天生的逆向情绪交易者。",
        'blindspot': "情绪共振过度与缺乏冷酷。你的高共情力是一把双刃剑。当市场极度恐慌时，你容易被这种集体悲伤吞噬，导致操作变形。你很难像机器一样冷酷地执行止损，因为潜意识里你觉得那是对自我的否定。此外，你容易因为追求完美的入场点而错过上车机会。",
        'strategy': "大周期择时 (Timing) / 情绪面分析 (Sentiment) / 价值定投。",
        'markets': "🔵 价值洼地资产 | 🔵 艺术品/NFT (文化属性) | 🔵 长线现货 (HODL)",
        'strengths': [
            "周期直觉：对牛熊转换有惊人的第六感，往往在崩盘前感到不安",
            "长期主义：能够忍受漫长的寂寞，做时间的朋友，拿得住百倍股",
            "风险嗅觉：比起利润，你对危险的气味更敏感，擅长逃顶"
        ],
        'weaknesses': [
            "容易抑郁：亏损会给你带来巨大的心理创伤，甚至影响生活",
            "缺乏果断：进场和出场总是犹豫，需要别人推一把 (Te 弱势)",
            "回避现实：亏损严重时会选择“卸载软件”装作看不见，变成鸵鸟"
        ],
        'win_condition': "大周期的底部区域（如极度恐慌时），或者有着宏大愿景且符合你价值观的项目爆发。",
        'loss_trigger': "高频交易（Scalping）或噪音极大的震荡市，这会让你精神崩溃。",
        'desk_setup': "🕯️ 神庙模式 (The Sanctuary)：\n- 环境：极其私密的空间，不要任何噪音，窗帘拉上。也许桌上会有香薰或冥想的摆件。\n- 配置：不需要多屏，一个屏幕看大周期足矣。旁边必定有纸质笔记本记录心得。\n- 氛围：与其说是交易室，不如说是心理咨询室，你需要在这里与市场对话。",
        'evolution': {
            'lvl1': "犹豫的观察者：看得很准，但不敢下单，事后拍大腿。",
            'lvl2': "周期捕手：克服了恐惧，敢于在无人问津时买入，人声鼎沸时离场。",
            'lvl3': "预言家：不仅交易，更输出投资哲学，成为指引他人的精神领袖。"
        },
        'tools': ["Fear & Greed Index (恐慌贪婪指数)", "Macro Charts (月线图)", "Journaling (手写日志)"],
        'partners': "📊 最佳拍档: ESTP\n你需要一个胆大包天、行动力极强的角斗士。当你在底部犹豫时，他会帮你按下买入键。"
    },
    'INFP': {
        'archetype': "坚守信仰的价值发现者 (The Mediator)",
        'tagline': "投资即投票，我只为我相信的世界买单。",
        'cognitive': "INFP（内向+直觉+情感+知觉）是真正的 HODLer（长期持有者）。Fi (内倾情感) 让你对认可的项目拥有宗教般的信念感。你投资的不是代码，而是愿景和价值观。Ne (外倾直觉) 让你能透过现在的简陋看到未来的繁荣。在别人因为短期波动离场时，你往往因为深度认同项目的“初心”，而吃到整个行业成长的最大红利。你在非标资产、文化属性赛道或ESG投资上天赋异禀。",
        'blindspot': "禀赋效应 (Endowment Effect) 与鸵鸟心态。你极其容易“爱上”你的持仓，把代币看作是你的孩子。你倾向于将“被套”美化为“为信仰买单”，不愿承认基本面已经恶化或团队已经跑路。这种对亏损项目的过度依恋，会导致资金利用率极低，甚至陪葬。",
        'strategy': "一级市场风投 (VC) / DAO 治理 / 收藏品投资。",
        'markets': "⚪️ 早期创投 (Angel Investing) | ⚪️ ESG/环保基金 | ⚪️ 稀缺收藏品/NFT",
        'strengths': [
            "钻石手 (Diamond Hands)：信念极其坚定，能够拿得住百倍币，不受洗盘影响",
            "审美红利：在NFT、艺术品和文化类资产上有极高造诣，懂“Vibe”和“社区文化”",
            "道德直觉：能避开那些虽然赚钱但价值观不正的庞氏骗局（有时候）"
        ],
        'weaknesses': [
            "感情用事：如果不喜欢项目方的CEO的人品，哪怕项目赚钱也不买，反之亦然",
            "鸵鸟心态：跌了就不敢看账户，幻想它会自动回本，缺乏止损概念",
            "缺乏变现：往往坐了一趟过山车（Round-trip），从A8回到A4，因为高点舍不得卖"
        ],
        'win_condition': "你看好的小众、边缘项目逐渐被主流大众接受并形成共识时（如早期的比特币）。",
        'loss_trigger': "项目方“人设崩塌”或背叛社区，这不仅让你亏钱，还会摧毁你的世界观。",
        'desk_setup': "📚 书房模式 (The Study)：\n- 环境：温馨、充满了个人色彩。周围堆满了书、艺术品和手办。不看K线，看白皮书和社区宣言。\n- 配置：简单的笔记本电脑，旁边可能是一杯热茶和一本诗集。\n- 氛围：与其说是交易，不如说是“赞助”你喜欢的世界。",
        'evolution': {
            'lvl1': "被割的情怀党：为信仰买单，容易成为庄家的“接盘侠”和“出口流动性”。",
            'lvl2': "早期发现者：利用敏锐的嗅觉发现百倍币的苗子，但还在学习如何卖出。",
            'lvl3': "顶级天使投资人：用资本推动世界向你看好的方向发展，实现财富与理想的统一。"
        },
        'tools': ["Whitepapers (白皮书)", "Discord Communities (社区)", "Art Galleries (艺术)"],
        'partners': "⚖️ 最佳拍档: ENTJ\n你需要一个无情的刽子手。当你沉浸在项目愿景中时，他会冷酷地帮你点击“全部卖出”，锁定利润。"
    },
    'ENFJ': {
        'archetype': "引领社区的布道者 (The Protagonist)",
        'tagline': "共识产生价值，而我创造共识。",
        'cognitive': "ENFJ（外向+直觉+情感+判断）是天生的社区领袖。在 Web3 和注意力经济中，你是绝对的赢家。Fe (外倾情感) 让你拥有极强的号召力和感染力，你不仅是交易者，更是意见领袖 (KOL)。Ni (内倾直觉) 让你能敏锐捕捉到哪些叙事 (Narrative) 能点燃大众的热情。你交易的不是资产本身，而是“人心”。你能比别人更早发现那些能够凝聚共识的标的。",
        'blindspot': "集体主义盲目与回声室效应 (Echo Chamber)。你极其容易陷入自己构建或身处的社交圈层中，只听得到赞同的声音。当整个社区都在疯狂喊单时，你会产生虚假的安全感，从而忽视了客观数据（如链上资金流出）。你需要警惕“叙事陷阱”，即故事很性感，但逻辑跑不通。",
        'strategy': "Meme 币捕捉 / 社区驱动型项目 / 跟单交易 (Copy Trading)。",
        'markets': "🟠 社区代币 (SocialFi) | 🟠 成长型科技股 (叙事强) | 🟠 众筹/DAO",
        'strengths': [
            "喊单之王：能通过影响力提升自己持仓的价值，自我实现预言",
            "人脉变现：拥有极广的信息源，这在信息不对称的市场比技术分析更重要",
            "情绪感知：清楚知道什么时候散户最疯狂，利用情绪溢价获利"
        ],
        'weaknesses': [
            "羊群效应：容易被周围人的情绪带偏，缺乏独立批判思维",
            "面子工程：为了维持“大神”或“坚定持有者”的人设而不敢承认亏损，死扛到底",
            "轻信他人：容易被包装精美的骗局项目方忽悠，甚至无意中成为帮凶"
        ],
        'win_condition': "情绪主导的泡沫期，或者依靠强大社区共识推动的行情（如Meme Season）。",
        'loss_trigger': "流动性枯竭的深熊市，无人响应你的呼唤，叙事变得一文不值。",
        'desk_setup': "🎙️ 演播室模式 (The Studio)：\n- 环境：灯光充足，背景专业。不仅用来交易，还用来直播、开Twitter Space。\n- 配置：专业的麦克风、摄像头是标配。屏幕上开着社交媒体的热度分析工具。\n- 氛围：充满活力，随时准备与世界连接。",
        'evolution': {
            'lvl1': "社群气氛组：帮别人喊单，自己亏钱，容易成为庄家的“喇叭”。",
            'lvl2': "社区领袖：能通过影响力获得早期筹码 (Whimlist)，实现无风险套利。",
            'lvl3': "顶级造势者：发起自己的项目或基金，制定规则，用共识创造百亿市值。"
        },
        'tools': ["Twitter Spaces (舆论场)", "Lunarcrush (社交声量)", "CRM (人脉管理)"],
        'partners': "📉 最佳拍档: ISTP\n你需要一个冷酷的技术流杀手。当你热血沸腾地讲述宏大叙事时，他会冷冷地告诉你：“K线破位了，快跑。”"
    },
    'ENFP': {
        'archetype': "热情的记者型 (The Campaigner)",
        'tagline': "生活是激动人心的戏剧，每一次相遇都是奇迹。",
        'cognitive': "ENFP（外向+直觉+情感+知觉）是“理想型”和“人性型”的结合。Ne (外倾直觉) 让你视灵感高于一切，你看到的不是孤立的人或事，而是和谐整体的一部分。你对他人的情绪极度敏感，拥有洞察事物深远意义的能力。你的能量来源于与人交往和探索新的可能性，依赖冲动的能量去开辟新道路。",
        'blindspot': "三分钟热度与边界感缺失。你倾向于开始很多事情却很难完成它们（尤其当有更新趣的东西出现时）。你容易将人或事理想化，常常陷入他人的情绪问题中无法自拔。面对枯燥的细节、最后期限和官僚作风，你会感到窒息并产生严重的拖延。",
        'strategy': "影响力变现 / 创意策划 / 关系连接。",
        'markets': "🟠 创意媒体与广告 | 🟠 人力资源与咨询 | 🟠 早期风投",
        'strengths': [
            "极强的即兴发挥能力：语言流畅，思维灵活，善于头脑风暴",
            "情感共鸣大师：深刻理解他人心情，善于安慰和鼓励",
            "宏观策略思维：能理解复杂理论，善于从整体把握事物"
        ],
        'weaknesses': [
            "难以落地：容易凭个人好恶决策，忽视客观实际",
            "缺乏界限：为了和睦牺牲自己利益，不善于管束或批评他人",
            "情绪波动：过于理想化，容易在期待落空时受到伤害"
        ],
        'win_condition': "拥有高度自由的发展空间，能够通过个人魅力和创意获得成就感，且没有官僚主义的环境。",
        'loss_trigger': "陷入充满常规琐事、需要处理大量枯燥数据且一成不变的工作。",
        'desk_setup': "🎨 创意工坊模式：\n- 环境：开放式空间，必须有趣。墙上可能有海报、便利贴或白板。\n- 物品：桌面上堆满了未完成的草稿、玩具和各种新奇的小玩意。\n- 氛围：允许背景音乐和随时的交谈。",
        'evolution': {
            'lvl1': "开心果：装疯卖傻融入人群，渴望成为焦点，但做事无条理，三分钟热度。",
            'lvl2': "变革者：利用洞察力发现新方法，开始在营销、传媒或咨询领域产生影响力。",
            'lvl3': "精神领袖：将理想主义落地，通过个人风格和媒体形象影响大众价值观，拯救“世界”。"
        },
        'tools': ["MindNode (思维导图)", "Notion (虽然很乱但很有用)", "Social Media"],
        'partners': "🎓 最佳拍档: ENFJ 或 INFJ\n你需要ENFJ (教育家型) 的引导，或者与记者型同类产生共鸣。"
    },
    'ISTJ': {
        'archetype': "精密严谨的审计师 (The Inspector)",
        'tagline': "纪律就是自由，复利是世界第八大奇迹。",
        'cognitive': "ISTJ（内向+实感+理智+判断）是纪律的化身。Si (内倾实感) 让你对历史数据有极高的尊重，相信“太阳底下无新事”，所有的行情都能在历史中找到影子。Te (外倾思考) 让你追求极致的执行效率。你的交易系统像瑞士钟表一样精密，绝不凭“感觉”下单。你厌恶风险和不确定性，通过严格的仓位管理和机械化执行，你往往能实现稳健的复利。",
        'blindspot': "缺乏变通与范式转移 (Paradigm Shift) 盲区。当市场结构发生根本性变化（如从技术驱动转向流动性驱动，或新资产类别诞生）时，你基于“历史回测”的僵化规则可能会彻底失效。你可能会因为一个指标未对齐而错过巨大的创新型行情（如早期的比特币），因为你的模型里“没有这项数据”。",
        'strategy': "网格交易 (Grid Trading) / 右侧突破 / 固定收益增强 (Fixed Income+)。",
        'markets': "🟢 国债/企业债 (Bonds) | 🟢 高股息蓝筹 (Dividend Stocks) | 🟢 机器化量化策略",
        'strengths': [
            "绝对风控：你的字典里没有“爆仓”这两个字，止损线是你的生命线",
            "数据说话：不信谣不传谣，只信财报、K线和经过回测的数学期望值",
            "情绪稳定：能够像机器人一样执行枯燥的重复性操作，不受盈亏干扰"
        ],
        'weaknesses': [
            "增长缓慢：在疯牛行情中容易跑输大盘，因为你总是过早止盈或仓位过轻",
            "思维僵化：难以接受“看不懂”的新资产，认为是泡沫而拒绝参与",
            "完美主义：因为等待一个“完美的”回调点位，而踏空了整整一轮牛市"
        ],
        'win_condition': "波动率稳定的震荡上行市场，或者规律性极强的周期性行情。",
        'loss_trigger': "无法用过往经验解释的“黑天鹅”事件，或者规则失效后的认知崩塌。",
        'desk_setup': "🗄️ 会计师模式 (The Auditor)：\n- 环境：一尘不染，井井有条。任何杂物都会让你分心。\n- 配置：标准的双屏。屏幕上永远开着Excel表格和交易日志。\n- 氛围：严肃、专业。墙上可能贴着打印出来的“交易原则10条”。",
        'evolution': {
            'lvl1': "存款特种兵：只敢存银行或买理财，看着通胀吞噬购买力。",
            'lvl2': "稳健交易员：建立了严格的交易系统，开始稳定盈利，虽然慢但从不回撤。",
            'lvl3': "风控大师：管理大资金，成为穿越牛熊的寿星，依靠复利成为巨富。"
        },
        'tools': ["Excel (深度使用)", "Grid Trading Bots (网格机器人)", "Ledger (冷钱包)"],
        'partners': "🚀 最佳拍档: ESTP\n你需要一个敢于冒险的先锋。带你去尝试一些高风险高回报的机会，打破你的思维禁锢。"
    },
    'ISFJ': {
        'archetype': "守护资产的守望者 (The Defender)",
        'tagline': "不亏就是赚，稳健长久远。",
        'cognitive': "ISFJ（内向+实感+情感+判断）极度厌恶风险，对“本金安全”有着刻在基因里的执着。Si (内倾实感) 让你成为完美的防御型投资者，你只会投资你完全熟悉的、看得见摸得着的资产。Fe (外倾情感) 让你将交易视为对家庭和未来的责任，而非个人的成就游戏。你可能不会在一夜之间暴富，但你也绝不会因为一次鲁莽的加杠杆而归零。非常适合作为家族财富的守门人。",
        'blindspot': "过度保守与通胀风险 (Inflation Risk)。为了规避名义价格的波动，你往往持有过多的现金或低收益理财。在通胀周期或资产泡沫期，你的账户余额虽然没少，但实际购买力却在大幅缩水（隐形亏损）。此外，由于 Ne (外倾直觉) 是短板，你对新事物充满恐惧，往往在趋势最明朗的末期才敢进场，成为接盘侠。",
        'strategy': "套利策略 (Arbitrage) / 质押生息 (Staking) / 指数定投。",
        'markets': "⚪️ 黄金/贵金属 (避险) | ⚪️ 货币基金/国债 | ⚪️ 银行理财/大额存单",
        'strengths': [
            "守财奴：极其擅长保住胜利果实，在熊市中往往能跑赢大多数激进的交易员",
            "细节控：能发现合同、规则或费率中的隐形陷阱，绝不会因为操作失误而亏钱",
            "听劝：愿意听取专家的建议，不瞎操作，执行力虽不快但很稳"
        ],
        'weaknesses': [
            "恐慌抛售：心理承受力较差，容易在市场底部的剧烈震荡中被吓出筹码",
            "机会成本：资金使用效率较低，完美错过了资产增值的黄金时期",
            "过度焦虑：过分关注账户的短期浮动，哪怕跌了1%也会让你睡不着觉"
        ],
        'win_condition': "高息环境（Cash is King）或漫长的熊市，当别人都在亏钱时，你在通过利息稳定获利。",
        'loss_trigger': "在市场底部因为极度恐慌而割肉离场，或者被通胀长期侵蚀。",
        'desk_setup': "🏠 家庭模式 (The Home Base)：\n- 环境：温馨、安全。书桌旁放着家人的照片，提醒你交易的目的是为了给他们更好的生活。\n- 配置：不需要复杂的屏幕，一台稳定的笔记本即可。旁边会有记账本。\n- 氛围：舒适、放松，像是在处理家务一样处理交易。",
        'evolution': {
            'lvl1': "存钱罐：只知道存银行，看着通胀慢慢吞噬购买力，不敢碰任何投资。",
            'lvl2': "理财达人：开始尝试低风险的基金和债券，跑赢通胀，积少成多。",
            'lvl3': "财富传承者：建立家族信托，配置保险和避险资产，实现资产的永续传承。"
        },
        'tools': ["Fixed Income Apps (固收)", "Gold (实物黄金)", "Insurance (保险)"],
        'partners': "🌪️ 最佳拍档: ENTP\n你需要一个眼光毒辣的谋士。他能带你看懂风险背后巨大的机会，防止你过于保守而错过时代。"
    },
    'ESTJ': {
        'archetype': "雷厉风行的执行官 (The Executive)",
        'tagline': "只有被执行的计划，才是好计划。",
        'cognitive': "ESTJ（外向+实感+理智+判断）是效率的化身。Te (外倾思考) 让你对“确定性”和“结果”有极致追求。你不相信直觉，只相信数据、报表和经过回测的策略。在单边趋势行情中，你的执行力是核武器，你能比任何人都更果断地开仓，并拿住单子直到趋势彻底反转。Si (内倾实感) 让你善于建立标准化的SOP（标准作业程序），将交易变成流水线作业。",
        'blindspot': "急于求成与过度操作。当市场处于无序震荡（垃圾时间）时，你“必须做点什么”的性格会害了你。你难以忍受空仓的无效率感，试图在没有规律的市场中强行寻找规律，导致频繁止损（Whipsaw），磨损本金。此外，你容易忽视“市场情绪”这一不可量化的变量。",
        'strategy': "趋势跟踪 (Trend Following) / 右侧突破 (Breakout) / 动量交易。",
        'markets': "🟤 大宗商品期货 (Commodities) | 🟤 龙头成长股 | 🟤 主流币趋势策略",
        'strengths': [
            "顶级执行力：也是止损最果断的人群之一，绝不拖泥带水",
            "完美记录：拥有像审计师一样的复盘账本，清楚知道每一分钱怎么赚/亏的",
            "严控回撤：绝不让单次亏损超过本金的 2%，风控是铁律"
        ],
        'weaknesses': [
            "震荡死穴：在猴市（Sideways）中容易被来回打脸，心态爆炸",
            "缺乏想象：可能错过比特币早期这种“看不懂、没财报”的机会",
            "路怒症：容易因为行情墨迹或滑点而产生愤怒情绪，导致动作变形"
        ],
        'win_condition': "波动率放大的单边趋势行情，无论是暴涨还是暴跌，只要有方向你就能赢。",
        'loss_trigger': "窄幅震荡市，你会因为频繁打脸而心态失衡，进而报复性频繁交易。",
        'desk_setup': "🏢 办公室模式 (The Office)：\n- 环境：像华尔街投行一样专业。墙上贴着你的“交易十诫”和打印出来的K线图。\n- 配置：多屏显示器，Bloomberg终端风格的配色。桌上只有键盘、鼠标和咖啡。\n- 氛围：高效、冷酷、充满压迫感。这里是战场，不是游乐场。",
        'evolution': {
            'lvl1': "勤奋的亏损者：每天盯盘10小时，操作猛如虎，一看战绩0-5，陷入无效努力。",
            'lvl2': "趋势猎手：学会了分辨“垃圾时间”，只在最有把握的突破时刻出击。",
            'lvl3': "基金经理：管理庞大的资金，用铁律约束团队，将个人能力转化为机构化的赚钱机器。"
        },
        'tools': ["TradeStation (专业终端)", "Trend Indicators (均线/布林)", "Journal (复盘软件)"],
        'partners': "🧠 最佳拍档: INTP\n你需要一个军师。他负责天马行空地研发新策略，你负责将其标准化并无情落地。"
    },
    'ESFJ': {
        'archetype': "消息灵通的市场中枢 (The Consul)",
        'tagline': "人脉即财脉，跟对人才能赚大钱。",
        'cognitive': "ESFJ（外向+实感+情感+判断）是天生的连接者。Fe (外倾情感) 让你通过广泛的社交网络，往往能在利好消息公布前就听到风声。你是“情绪面”和“消息面”的高手，能够敏锐感知市场参与者的水位。Si (内倾实感) 让你偏好那些看得见、摸得着、有很多人讨论的热门资产。在散户主导的市场（如Meme或牛市中后期）中，你能准确预判资金的下一个去向，因为你就是大众心理的晴雨表。",
        'blindspot': "羊群效应 (Herding) 与缺乏独立判断。你很容易受到周围人观点的影响，缺乏批判性思维。切记：人多的地方不要去。当连你身边的外行都在讨论买入时，往往是你的离场时机。你需要建立一套独立于朋友圈之外的验证系统，否则极其容易成为庄家出货的“接盘侠”。",
        'strategy': "跟单交易 (Copy Trading) / 社交化投资 / 事件驱动 (Event-Driven)。",
        'markets': "🟣 热门板块轮动 (Sector Rotation) | 🟣 社交型代币 (SocialFi) | 🟣 消费类股票",
        'strengths': [
            "顺风耳：总能第一时间知道哪里有热点，哪里有金狗，信息差是你最大的优势",
            "组局者：擅长整合资源，跟着大佬喝汤，或者拿到一级市场的额度",
            "跑得快：风向不对时，你是跑得最快的那批人，因为你对危险气氛很敏感"
        ],
        'weaknesses': [
            "盲从：容易被所谓的大V喊单收割，把“割韭菜”的镰刀当成救世主",
            "FOMO (错失恐惧症) 严重：看到别人赚钱比自己亏钱还难受，导致高位追涨",
            "缺乏主见：一旦被套就不知道该怎么办，四处问人，错失止损良机"
        ],
        'win_condition': "热点频出的板块轮动行情，或者社交媒体驱动的泡沫期。",
        'loss_trigger': "由于轻信“内幕消息”而重仓梭哈，或者在熊市中因为恐慌而杀跌。",
        'desk_setup': "📱 社交模式 (The Social Hub)：\n- 环境：热闹、充满人气。你可能根本不需要电脑，一部手机走天下。\n- 配置：手机上装满了微信、Telegram、Discord和推特。通知消息响个不停。\n- 氛围：时刻在线，生怕错过群里的一条重要消息。",
        'evolution': {
            'lvl1': "韭菜：听风就是雨，每天在各种群里问“财富密码”，专业接盘。",
            'lvl2': "情报站：建立了可靠的信息源过滤机制，能鉴别真假消息，吃到第一波肉。",
            'lvl3': "一级市场大佬：通过顶级人脉拿到早期私募份额，成本极低，成为资源的分配者。"
        },
        'tools': ["Telegram/Discord (情报源)", "Twitter Lists (信息流)", "Whale Alert (大户监控)"],
        'partners': "🦅 最佳拍档: INTJ\n你需要一个冷酷的过滤器。他能帮你过滤掉99%的噪音，告诉你哪个消息在逻辑上是站得住脚的。"
    },
    'ISTP': {
        'archetype': "冷静精准的狙击手 (The Virtuoso)",
        'tagline': "给我一张K线图，我可以撬动地球。",
        'cognitive': "ISTP（内向+实感+理智+知觉）是天生的短线杀手。Ti (内倾思考) 让你拥有剔除噪音、直击本质的分析能力，你不在乎基本面故事，只相信价格行为 (Price Action)。Se (外倾实感) 赋予了你对盘面微小波动的极致敏感度。你不需要宏大的理论，只需要一把“枪”（技术指标）和一颗子弹（本金）。你是最适合做日内波段（Swing）或高频交易的人群，能在混乱中保持绝对冷静，泰山崩于前而色不变。",
        'blindspot': "战术勤奋与战略懒惰。你太沉迷于战术上的胜利（每一单都赚），而忽略了战略上的风险（赛道正在消失或大周期见顶）。你容易“捡了芝麻丢了西瓜”，在巨大的趋势行情中，因为过早止盈或试图做回调（逆势）而错失百倍机会。此外，你容易过度自信于自己的反应速度。",
        'strategy': "日内波段 / 剥头皮 (Scalping) / 技术形态突破。",
        'markets': "🟢 股指期货 (Index Futures) | 🟢 外汇高杠杆 (Forex) | 🟢 波动率交易 (VIX)",
        'strengths': [
            "极速反应：在黑天鹅事件中能比别人快0.5秒跑路，或者在暴跌瞬间反手做空",
            "绝对冷静：拥有大心脏，情绪剥离能力极强，把亏损看作是生意的成本",
            "技术流：精通各种K线形态、指标和订单流 (Order Flow)，是工具的主人"
        ],
        'weaknesses': [
            "格局受限：习惯看5分钟/15分钟图，很少看周线图，导致缺乏大局观",
            "赌徒心理：容易在亏损后“上头”，加杠杆博回本，陷入赌徒谬误",
            "缺乏耐性：持仓超过三天就浑身难受，必须动一动，导致过度交易 (Over-trading)"
        ],
        'win_condition': "高频波动的震荡行情，或者是技术形态极其标准的突破行情。",
        'loss_trigger': "试图在单边暴涨/暴跌中“摸顶抄底”而被趋势碾压，或者被低流动性的盘面困住。",
        'desk_setup': "🎮 电竞模式 (Esports Setup)：\n- 环境：酷炫、暗黑。RGB灯光是标配，像个职业电竞选手。\n- 配置：高刷新率(144Hz+)显示器，机械键盘(红轴/银轴)用于极速下单，有线鼠标防延迟。\n- 氛围：肾上腺素飙升，专注于当下的每一秒。",
        'evolution': {
            'lvl1': "频繁交易员：为了交易而交易，每天开单50次，手续费比利润还高。",
            'lvl2': "狙击手：学会了空仓等待，像鳄鱼一样潜伏，只在胜率最高的形态出现时一击必中。",
            'lvl3': "传奇操盘手：将盘感内化为直觉，甚至不需要指标，凭价格跳动的韵律就能在市场中提款。"
        },
        'tools': ["TradingView (技术分析)", "Bookmap (深度图)", "Stream Deck (一键宏)"],
        'partners': "📢 最佳拍档: ENFJ\n你需要一个看大方向的人。他能带你看懂宏观叙事和情绪面，防止你在即将爆发的赛道里做空。"
    },
    'ISFP': {
        'archetype': "随波逐流的盘感艺术家 (The Adventurer)",
        'tagline': "不要与趋势作对，像水一样流动。",
        'cognitive': "ISFP（内向+实感+情感+知觉）将交易视为一种艺术表现。Fi (内倾情感) 让你不依赖死板的指标，而是通过内心的“确认感”来下单。Se (外倾实感) 让你能敏锐感受到价格流动的韵律 (Market Rhythm) 和力度的强弱转化。这种独特的天赋让你在震荡市中如鱼得水，能够灵活切换多空方向。你对市场的“美感”有直觉，知道什么样的图形是“漂亮的、要涨的图形”。",
        'blindspot': "情绪化交易与报复性操作。你的状态极度依赖心情。一旦节奏被打乱，或者遭遇连续止损，你容易陷入情绪崩溃 (Tilt)，进而进行报复性交易，试图立即把钱赚回来。你需要一个外部的“风控官”或硬性程序来限制你的每日亏损额度，因为你很难自我约束。",
        'strategy': "主观波段交易 (Discretionary Swing) / 形态学分析 / 右侧交易。",
        'markets': "⚪️ 贵金属现货 (Gold/Silver) | ⚪️ 消费品期货 | ⚪️ 艺术品/NFT (审美溢价)",
        'strengths': [
            "极佳盘感：能感受到盘面的呼吸和情绪，往往在指标金叉之前就已经进场了",
            "灵活多变：从不死板，错了立马认错反手，像水一样适应容器（市场）",
            "心态佛系：在顺境中能保持极好的松弛感，赚钱了开心，亏钱了也不太纠结（前提是没上头）"
        ],
        'weaknesses': [
            "容易崩坏：心态容易受生活琐事影响，和恋人吵架可能会导致你爆仓",
            "缺乏计划：经常凭感觉下单，进场了才想起来没设止损位",
            "报复市场：上头时会把一个月的利润在一天内亏光，缺乏资金管理概念"
        ],
        'win_condition': "走势流畅、技术形态标准且符合你审美直觉的行情。",
        'loss_trigger': "连续的假突破磨损你的耐心，或者生活中的负面情绪带入交易。",
        'desk_setup': "🎨 工作室模式 (The Studio)：\n- 环境：舒适、悦己。放着你喜欢的Lo-Fi音乐，点着香薰，甚至旁边有杯红酒。\n- 配置：不需要太多屏幕，但显示器色彩要好。界面UI必须美观。\n- 氛围：自由自在，不仅是交易，更是生活方式的一部分。",
        'evolution': {
            'lvl1': "凭感觉亏钱：心情好就赚，心情差就亏，账户曲线像心电图。",
            'lvl2': "盘感高手：建立了属于自己的图形库，能感知市场呼吸，胜率惊人。",
            'lvl3': "交易艺术家：达到了“人盘合一”的境界，交易不再是压力，而是像呼吸一样自然。"
        },
        'tools': ["Candlestick Patterns (裸K)", "Music (调节心流)", "Meditation (冥想)"],
        'partners': "🦁 最佳拍档: ENTJ\n你需要一个强势的教官。给你提供大方向，并在你情绪失控时强行拔掉你的网线。"
    },
    'ESTP': {
        'archetype': "与波动共舞的角斗士 (The Entrepreneur)",
        'tagline': "风险越高，奖赏越大。",
        'cognitive': "ESTP（外向+实感+理智+知觉）是为高波动而生的战士。Se (外倾实感) 赋予了你哪怕0.1秒的盘口反应优势。你不需要复杂的宏观理论，你通过“手感”和“盘口跳动”来感知资金流向。Ti (内倾思考) 帮你迅速计算赔率。风险对别人是压力，对你却是兴奋剂。你在面对突发利空时，往往能比别人更快地反手做空，将危机转化为暴利。",
        'blindspot': "多巴胺成瘾与赌徒谬误。你容易把交易变成单纯的刺激游戏。在连续盈利后，你会产生虚幻的“不可战胜感”，从而重仓梭哈一把归零。你最大的敌人不是市场，而是无聊。你很难忍受空仓等待的寂寞，容易在没有机会时强行开单 (Forcing trades)。",
        'strategy': "高频剥头皮 (Scalping) / 新闻交易 (News Trading) / 杠杆博弈。",
        'markets': "🔴 权证/牛熊证 (Warrants) | 🔴 杠杆ETF (3x Leverage) | 🔴 加密货币永续合约",
        'strengths': [
            "速度之王：手速和脑速都极快，擅长抢帽子，在黑天鹅事件中能比别人快一步",
            "拥抱风险：敢于在别人恐惧时贪婪，抄底最坚决，敢死队精神",
            "极速纠错：从不纠结沉没成本，该割就割，绝不拖泥带水，没有任何感情色彩"
        ],
        'weaknesses': [
            "赌性太重：容易把交易变成赌博，All in 归零，追求一夜暴富",
            "频繁止损：因为手痒而做了一堆无效的磨损交易，手续费惊人",
            "不爱深度思考：讨厌研究基本面和长篇大论的财报，认为那是马后炮"
        ],
        'win_condition': "剧烈波动的单边行情，或者黑天鹅爆发的混乱时刻（Volatility is your friend）。",
        'loss_trigger': "阴跌的熊市或极度窄幅的震荡市，你会因为频繁“试错”而把本金磨光。",
        'desk_setup': "🏎️ 赛车手模式 (The Racer)：\n- 环境：可以有背景音乐（快节奏），甚至可以在喧闹的交易室，噪音让你兴奋。\n- 配置：单屏或双屏高刷显示器。外设必须是顶级的，机械键盘（青轴）和高DPI鼠标，要的就是敲击的确认感。\n- 氛围：战斗气息浓厚，时刻准备冲刺。",
        'evolution': {
            'lvl1': "疯狂赌徒：凭直觉梭哈，赚得快亏得更快，账户大起大落，经常爆仓。",
            'lvl2': "短线高手：掌握了盘口语言，胜率极高，但依然面临回撤控制问题。",
            'lvl3': "传奇游资：学会了休息和空仓，只在确定性最高的时刻像鳄鱼一样出击，一战封神。"
        },
        'tools': ["Bookmap (深度图)", "TradeTheNews (快讯流)", "One-click Trading (一键下单)"],
        'partners': "🛡️ 最佳拍档: INFJ\n你需要一个能看到长期后果的“刹车片”。在他提醒你“前面有悬崖”时，务必停手。"
    },
    'ESFP': {
        'archetype': "活在当下的投机客 (The Entertainer)",
        'tagline': "人生苦短，及时行乐，满仓干！",
        'cognitive': "ESFP（外向+实感+情感+知觉）是天生的市场情绪放大器。Se (外倾实感) 让你活在当下，你是最享受市场泡沫的人，因为你敢于在别人犹豫的时候按下买入键。Fi (内倾情感) 让你极度依赖直觉和喜好——“这个代码（Ticker）名字好听，买！”。你的直觉和运气往往能让你在短时间内获得惊人的回报，因为在非理性的牛市中，只有疯子才能跑赢指数。",
        'blindspot': "缺乏规划与风控缺失。你赚得快，亏得也快。由于缺乏风控意识，你往往在市场见顶后依然幻想“再创新高”，导致利润回撤极其剧烈（Profit Giving Back）。你很难区分“运气”和“能力”，容易在熊市初期因为试图抄底而把牛市赚的钱全部送回去。",
        'strategy': "短线爆发性行情 / 小币种博弈 / 追涨杀跌 (Momentum Trading)。",
        'markets': "🟤 仙股 (Penny Stocks) | 🟤 热门题材 (Hot Concepts) | 🟤 彩票型期权 (0DTE)",
        'strengths': [
            "运气爆棚：往往能蒙对妖股（其实是潜意识捕捉到了热度），新手光环最强",
            "敢打敢冲：在牛市主升浪中收益率最高，因为你从不恐高",
            "乐观主义：心态极好，亏完了也能睡得着觉，大不了重头再来"
        ],
        'weaknesses': [
            "毫无风控：不知道什么叫仓位管理，习惯性满仓梭哈 (All-in)",
            "利润回吐：经常坐过山车，怎么上去怎么下来，缺乏“落袋为安”的机制",
            "不爱学习：讨厌研究复杂的财报和枯燥的技术指标，只看KOL喊单"
        ],
        'win_condition': "流动性泛滥、群魔乱舞的疯牛市场 (Bubble Phase)。",
        'loss_trigger': "阴跌的熊市或逻辑驱动的存量博弈市场，你的直觉会失效。",
        'desk_setup': "🎉 派对模式 (The Party)：\n- 环境：随性、自由。你可能根本不在电脑前，而是在酒吧、沙滩或聚会上用手机交易。\n- 配置：一部最新款的手机，装好最好用的交易App。\n- 氛围：交易是生活的一部分，赚钱是为了更好地消费。",
        'evolution': {
            'lvl1': "散户战神：凭运气赚的钱，最终凭实力亏光，不仅亏钱还欠债。",
            'lvl2': "投机高手：学会了看风向，跑得比别人快，成了市场里的“滑头”。",
            'lvl3': "市场赢家：懂得了将投机利润转移到低风险资产中，享受生活，深藏功与名。"
        },
        'tools': ["Sentiment Analysis (情绪分析)", "Social Volume (社交声量)", "Mobile Apps"],
        'partners': "🦅 最佳拍档: INTJ\n你需要一个严肃的管家。帮你构建系统，锁住利润，并没收你的交易密码防止你乱动。"
    }
}

# ==============================
# 3.x 机构化增强报告生成器 (append after REPORT_TEMPLATES)
# ==============================

DIM_EXPLAIN = {
    "E": "外向(E)：信息来源偏社交与热度；优势在于情绪与资金的共振捕捉，风险在于回声室与FOMO。",
    "I": "内向(I)：信息来源偏独立研究；优势在于低噪音决策与深度复盘，风险在于错过窗口与过度确认。",
    "S": "实感(S)：偏好可验证数据/价格行为；优势在于执行稳定，风险在于忽视范式转移与叙事溢价。",
    "N": "直觉(N)：偏好叙事/趋势/周期位置；优势在于提前布局大机会，风险在于把想象当事实与叙事过拟合。",
    "T": "理智(T)：偏好概率/期望值/规则；优势在于风控与一致性，风险在于低估市场非理性与流动性冲击。",
    "F": "情感(F)：偏好价值/人性/情绪；优势在于理解共识与社区，风险在于信仰仓与沉没成本。",
    "J": "判断(J)：偏好计划/纪律/确定性；优势在于回撤控制，风险在于在震荡市“系统被磨损”。",
    "P": "知觉(P)：偏好灵活/探索/应变；优势在于适应结构变化，风险在于过度交易与规则漂移。"
}

MARKET_FIT = {
    "SN": {
        "S": "更适合：主流币趋势/订单流/结构明确的品种（BTC/ETH、股指、外汇主流对）。",
        "N": "更适合：叙事驱动与周期轮动（新公链、赛道轮动、宏观拐点布局）。"
    },
    "TF": {
        "T": "更适合：规则化策略、量化/半量化、期权结构与对冲。",
        "F": "更适合：社区/注意力资产、叙事驱动、文化属性强的品种（Meme/NFT/社交代币）。"
    },
    "JP": {
        "J": "更适合：计划型执行（突破/趋势跟随/网格/固定SOP）。",
        "P": "更适合：事件驱动/波段/快速试错（但必须有硬风控）。"
    }
}

def _pct(a, b):
    total = max(a + b, 1)
    return int(a / total * 100)

def build_profile_addendum(mbti: str, scores: Counter) -> dict:
    """
    根据四维字母 + 作答强弱(百分比) 生成“机构化增补”文本。
    目的：让每个类型都有足够长且更严谨的分析。
    """
    e, i = scores.get('E', 0), scores.get('I', 0)
    s, n = scores.get('S', 0), scores.get('N', 0)
    t, f = scores.get('T', 0), scores.get('F', 0)
    j, p = scores.get('J', 0), scores.get('P', 0)

    pe, pn, pt, pj = _pct(e, i), _pct(n, s), _pct(t, f), _pct(j, p)  # 注意：pn 是 N 强度
    # 强度标签（让报告更“量化”）
    def strength_label(x):
        if x >= 70: return "强"
        if x >= 55: return "中强"
        if x >= 45: return "均衡"
        if x >= 30: return "中弱"
        return "弱"

    dim_text = "\n".join([DIM_EXPLAIN[ch] for ch in mbti])

    # 机构化 SOP（按维度组合）
    risk_protocol = (
        f"【风控协议】你的纪律强度(J={pj}%, {strength_label(pj)}) 与理性强度(T={pt}%, {strength_label(pt)})决定了你能否稳定穿越波动。\n"
        f"- 单笔风险：建议 0.5%~1.5%（越接近P或F越取下限）。\n"
        f"- 日内最大亏损：2R 或 2%（触发立即停止交易并复盘）。\n"
        f"- 黑天鹅模式：只允许减仓/对冲，不允许“加杠杆抄底”。\n"
        f"- 复利模式：当周盈利>3R，允许上调仓位10%~20%；当周回撤>3R，强制下调仓位30%并进入观察期。"
    )

    execution_sop = (
        "【执行SOP】\n"
        "1) 入场：必须同时满足「结构信号」+「流动性/成交量确认」+「止损位可定义」。\n"
        "2) 止损：先写止损再下单；止损不允许“凭感觉挪远”。\n"
        "3) 止盈：至少分两段（TP1锁利润 + TP2跟随趋势/移动止损）。\n"
        "4) 复盘：记录触发信号、进出场理由、执行偏差、情绪水平(0-10)、滑点/手续费。"
    )

    review_checklist = (
        "【复盘清单】\n"
        "- 每日：今天是否遵守单笔风险？是否出现“为交易而交易”？是否在不确定环境里加杠杆？\n"
        "- 每周：最大回撤来自哪类错误（信号错误/执行错误/情绪错误/信息污染）？\n"
        "- 每月：你的优势赛道是否仍有效（波动率、流动性、叙事阶段是否变化）？"
    )

    market_fit = (
        f"{MARKET_FIT['SN'][mbti[1]]} \n"
        f"{MARKET_FIT['TF'][mbti[2]]} \n"
        f"{MARKET_FIT['JP'][mbti[3]]}"
    )

    alpha_source = (
        "【Alpha来源（机制解释）】\n"
        "- 你赚钱不是因为“看对一次”，而是因为你在某类环境下能持续做对“决策过程”。\n"
        "- 当市场结构与你的感知/判断偏好一致时，你的胜率与盈亏比会同步提升；反之你会出现“信号看起来都对但就是亏钱”的磨损期。"
    )

    failure_mode = (
        "【典型失效模式】\n"
        "- 震荡磨损：在没有趋势/没有事件驱动时频繁试错，手续费与小止损累积吞噬利润。\n"
        "- 叙事反噬：把“故事”当成“事实”，或在流动性退潮期仍按牛市思维持仓。\n"
        "- 情绪漂移：连续盈利/亏损后改变规则（尤其P与F偏强时更常见）。"
    )

    return {
        "dimension_appendix": dim_text,
        "market_fit_appendix": market_fit,
        "alpha_appendix": alpha_source,
        "failure_appendix": failure_mode,
        "risk_protocol": risk_protocol,
        "execution_sop": execution_sop,
        "review_checklist": review_checklist
    }

# ==========================================
# 4. 逻辑控制与状态管理
# ==========================================

if 'step' not in st.session_state:
    st.session_state.step = 'intro'
if 'current_idx' not in st.session_state:
    st.session_state.current_idx = 0
if 'answers' not in st.session_state:
    st.session_state.answers = {}
if 'mbti_result' not in st.session_state:
    st.session_state.mbti_result = ''

# 初始为20题短测，完成后可选择生成报告或继续全量题库
if 'max_questions' not in st.session_state:
    st.session_state.max_questions = 20
if 'is_extended' not in st.session_state:
    st.session_state.is_extended = False

def handle_option(value):
    st.session_state.answers[st.session_state.current_idx] = value

    # 以 max_questions 控制当前测评长度：先20题短测，用户可选择继续全量题库
    max_q = int(st.session_state.get('max_questions', 20))
    total_q = len(RAW_QUESTIONS)
    idx = st.session_state.current_idx

    # 还没到当前阶段的最后一题：继续下一题
    if idx < max_q - 1:
        st.session_state.current_idx += 1
        return

    # 到了短测(20题)结束点：进入选择页
    if (max_q < total_q) and (not st.session_state.get('is_extended', False)):
        st.session_state.current_idx += 1  # 指向下一题(第21题)
        st.session_state.step = 'checkpoint'
        return

    # 全量题库已完成：生成报告
    if idx >= total_q - 1:
        st.session_state.step = 'analyzing'
        calculate_result()
        return

    # 兜底：如果 max_questions 被设为 total_q 但 idx 还没到末尾
    st.session_state.current_idx += 1

def calculate_result():
    scores = Counter(st.session_state.answers.values())
    st.session_state.mbti_scores = scores
    
    e, i = scores.get('E', 0), scores.get('I', 0)
    s, n = scores.get('S', 0), scores.get('N', 0)
    t, f = scores.get('T', 0), scores.get('F', 0)
    j, p = scores.get('J', 0), scores.get('P', 0)
    
    dim1 = 'E' if e >= i else 'I'
    dim2 = 'S' if s >= n else 'N'
    dim3 = 'T' if t >= f else 'F'
    dim4 = 'J' if j >= p else 'P'
    mbti_type = f"{dim1}{dim2}{dim3}{dim4}"
    st.session_state.mbti_result = mbti_type

    total_ei = e + i if (e + i) > 0 else 1
    total_sn = s + n if (s + n) > 0 else 1
    total_tf = t + f if (t + f) > 0 else 1
    total_jp = j + p if (j + p) > 0 else 1

    pct_e = int((e / total_ei) * 100)
    pct_n = int((n / total_sn) * 100)
    pct_t = int((t / total_tf) * 100)
    pct_j = int((j / total_jp) * 100)
    pct_p = int((p / total_jp) * 100)
    
    radar_scores = {
        '风控力': int((pct_j * 0.6 + pct_t * 0.4)),
        '心态值': int((pct_t * 0.7 + (100-pct_e) * 0.3)),
        '敏捷度': int((pct_p * 0.6 + pct_e * 0.4)),
        '宏观感': int(pct_n),
        '执行力': int(pct_j)
    }
    
    st.session_state.radar_scores = radar_scores

def reset_test():
    st.session_state.step = 'intro'
    st.session_state.current_idx = 0
    st.session_state.answers = {}
    st.session_state.mbti_result = ''


# ---------- 渲染辅助函数（将大块 HTML 提取为函数，便于维护）
def build_traits_html(mbti: str) -> str:
    traits_html = ""
    for char in mbti:
        t_data = TRAIT_DESCRIPTIONS.get(char, {'tag': '未知', 'desc': ''})
        traits_html += f"""<div class="trait-box">
<div class="trait-letter" style="color: #60a5fa;">{char}</div>
<div class="trait-name">{t_data['tag']}</div>
<div class="trait-bar"></div>
</div>"""
    return traits_html


def render_result_header(mbti: str, archetype_name: str, template: dict) -> None:
    traits_html = build_traits_html(mbti)
    st.markdown(f"""
<div class="result-header-container">
<div class="archetype-badge">ZEUS TRADING PROFILE • {mbti}</div>
<h1 class="main-title-gradient">{archetype_name}</h1>
<p style="color: #64748b; font-size: 1.1em; margin-top: -15px; font-weight: 500;">{template.get('archetype', '')}</p>
<div style="font-size: 1.3em; font-style: italic; color: #e2e8f0; margin: 20px 0; font-family: 'Georgia', serif;">
“{template.get('tagline', '')}”
</div>
<div class="traits-grid" style="max-width: 700px; margin: 0 auto;">
{traits_html}
</div>
</div>
""", unsafe_allow_html=True)


def get_radar_html(radar_scores: dict) -> str:
    radar_html = ""
    for k, v in radar_scores.items():
        bar_color = "#4ade80" if v >= 75 else ("#60a5fa" if v >= 50 else "#f87171")
        radar_html += f"""
<div style="margin-bottom: 12px;">
<div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
<span style="color: #94a3b8; font-size: 0.85em; font-weight: 600;">{k}</span>
<span style="color: {bar_color}; font-weight: bold; font-size: 0.9em;">{v}</span>
</div>
<div style="height: 6px; background: #334155; border-radius: 3px; overflow: hidden;">
<div style="width: {v}%; height: 100%; background: {bar_color}; border-radius: 3px; box-shadow: 0 0 10px {bar_color};"></div>
</div>
</div>"""
    return radar_html


# ==========================================
# 5. 页面视图 (Views)
# ==========================================

# --- 首页 ---
if st.session_state.step == 'intro':
    st.markdown("""
    <div style='text-align: center; padding: 60px 0;'>
        <div style='display: inline-block; padding: 8px 16px; background: rgba(59, 130, 246, 0.1); border-radius: 20px; color: #60a5fa; margin-bottom: 20px; font-size: 0.9em; border: 1px solid rgba(59, 130, 246, 0.2);'>
            ⚡ Zeuspace Trading Lab · 交易员潜能评估系统
        </div>
        <h1 style='font-size: 3.5em; font-weight: 800; background: linear-gradient(to right, #ffffff, #94a3b8); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 20px; color: white;'>
            你的性格，<br>决定你的<span style='color: #4ade80; -webkit-text-fill-color: #4ade80;'>盈亏比</span>
        </h1>
        <p style='color: #cbd5e1; font-size: 1.2em; line-height: 1.6; max-width: 600px; margin: 0 auto 40px auto;'>
            这不仅仅是心理测试。Zeuspace 结合行为金融学与 MBTI 深度量表，
            为您揭示潜意识中的交易行为模式，并匹配适合您性格的交易赛道。
        </p>
    </div>
    """, unsafe_allow_html=True)
    
    c1, c2, c3 = st.columns([1, 2, 1])
    with c2:
        if st.button("开始深度测评 →", type="primary", use_container_width=True):
            st.session_state.step = 'quiz'
            st.session_state.current_idx = 0
            st.session_state.answers = {}
            st.session_state.mbti_result = ''
            st.session_state.max_questions = 20
            st.session_state.is_extended = False
            st.rerun()
            
    st.markdown("<p style='text-align: center; color: #64748b; font-size: 0.8em; margin-top: 40px;'>Zeuspace Research • 非投资建议</p>", unsafe_allow_html=True)

# --- 答题页 ---
elif st.session_state.step == 'quiz':
    max_q = int(st.session_state.get('max_questions', 20))
    max_q = min(max_q, len(RAW_QUESTIONS))
    q_data = RAW_QUESTIONS[st.session_state.current_idx]
    progress = (st.session_state.current_idx + 1) / max_q
    
    st.progress(progress)
    st.caption(f"Question {st.session_state.current_idx + 1}/{max_q} • {q_data['d']} 维度")
    
    st.markdown(f"""
    <div style='min-height: 180px; display: flex; flex-direction: column; justify-content: center; margin: 20px 0;'>
        <h2 style='font-size: 1.8em; font-weight: 600; color: #f8fafc;'>{q_data['text']}</h2>
    </div>
    """, unsafe_allow_html=True)
    
    col1, col2 = st.columns(2)
    with col1:
        if st.button(q_data['a'], use_container_width=True):
            handle_option(q_data['d'][0])
            st.rerun()
    with col2:
        if st.button(q_data['b'], use_container_width=True):
            handle_option(q_data['d'][1])
            st.rerun()


# --- 20题完成后的选择页 ---
elif st.session_state.step == 'checkpoint':
    st.markdown("<div style='height: 12vh;'></div>", unsafe_allow_html=True)
    st.markdown("<h2 style='text-align:center; color:#60a5fa;'>阶段一完成：20/20</h2>", unsafe_allow_html=True)
    st.markdown(
        """<div class='css-card' style='text-align:center;'>
            <div style='font-size:1.05em; color:#cbd5e1; line-height:1.7;'>
                你已经完成 <b>20道核心题</b>。现在可以立即生成报告（速度快），或继续完成全量题库以提升准确度与细节。
            </div>
            <div style='margin-top:10px; color:#64748b; font-size:0.9em;'>
                建议：如果你在关键维度上比较“摇摆”，继续答题会更接近真实画像。
            </div>
        </div>""",
        unsafe_allow_html=True
    )

    col1, col2 = st.columns(2)
    with col1:
        if st.button("✅ 直接生成报告", type="primary", use_container_width=True):
            calculate_result()
            st.session_state.step = 'analyzing'
            st.rerun()
    with col2:
        if st.button("➕ 继续答题（更准确）", use_container_width=True):
            st.session_state.is_extended = True
            st.session_state.max_questions = len(RAW_QUESTIONS)
            st.session_state.step = 'quiz'
            st.rerun()

    st.markdown("<div style='height: 8px;'></div>", unsafe_allow_html=True)
    if st.button("↩︎ 重新开始测评", use_container_width=True):
        st.session_state.step = 'intro'
        st.session_state.current_idx = 0
        st.session_state.answers = {}
        st.session_state.mbti_result = ''
        st.session_state.max_questions = 20
        st.session_state.is_extended = False
        st.rerun()

# --- 分析页 ---
elif st.session_state.step == 'analyzing':
    st.markdown("<div style='height: 30vh;'></div>", unsafe_allow_html=True)
    st.markdown("<h2 style='text-align: center; color: #60a5fa;'>Zeuspace Neural Engine</h2>", unsafe_allow_html=True)
    
    status_text = st.empty()
    bar = st.progress(0)
    
    for i in range(100):
        time.sleep(0.01) 
        bar.progress(i + 1)
        if i == 30: status_text.markdown("<p style='text-align:center'>正在解析行为金融学数据...</p>", unsafe_allow_html=True)
        elif i == 60: status_text.markdown("<p style='text-align:center'>匹配全球资产风险偏好...</p>", unsafe_allow_html=True)
        elif i == 90: status_text.markdown("<p style='text-align:center'>生成个性化分析报告...</p>", unsafe_allow_html=True)
            
    st.session_state.step = 'result'
    st.rerun()

# --- 结果页 ---
# --- 结果页 (Zeuspace Professional View) ---
# --- 结果页 (Zeuspace Professional View) ---
elif st.session_state.step == 'result':
    mbti = st.session_state.mbti_result
    
    # 1. 获取数据
    default_data = {
        'archetype': f"未定义类型 ({mbti})", 'tagline': "数据加载中...", 
        'cognitive': "暂无数据", 'blindspot': "暂无数据",
        'markets': "暂无", 'strategy': "暂无", 'win_condition': "暂无", 'loss_trigger': "暂无",
        'strengths': [], 'weaknesses': [], 'tools': [], 'partners': "暂无",
        'desk_setup': "暂无配置建议",
        'evolution': {'lvl1': 'N/A', 'lvl2': 'N/A', 'lvl3': 'N/A'}
    }
    template = REPORT_TEMPLATES.get(mbti, default_data)
    scores = st.session_state.get("mbti_scores", Counter())
    addon = build_profile_addendum(mbti, scores)

    # 把增强文本拼接到原来的字段里（让内容立刻变长且更严谨）
    template["cognitive"] = template.get("cognitive", "") + "\n\n" + addon["alpha_appendix"] + "\n\n" + addon["dimension_appendix"]
    template["blindspot"] = template.get("blindspot", "") + "\n\n" + addon["failure_appendix"]
    template["markets"] = template.get("markets", "") + "\n\n" + addon["market_fit_appendix"]
    
    radar_scores = st.session_state.get('radar_scores', {'风控力':50, '心态值':50, '敏捷度':50, '宏观感':50, '执行力':50})

    # 解析标题名称
    full_archetype = template.get('archetype', f"Trader ({mbti})")
    if '(' in full_archetype:
        archetype_name = full_archetype.split('(')[0]
    else:
        archetype_name = full_archetype

    # -------------------------------------------------------
    # [修改重点] 顶部 Hero Section (图文并茂版)
    # -------------------------------------------------------
    
    # 1. 获取图片路径 (默认显示 INTJ 或一张占位图)
    image_path = MBTI_IMAGES.get(mbti, os.path.join(SCRIPT_DIR, "static/images/INTJ.png")) 
    
    # 2. 创建两栏布局：左侧文字，右侧图片 (或者反过来，根据喜好)
    # 参数 [1.2, 1] 表示左侧文字栏比右侧图片栏稍宽
    hero_col1, hero_col2 = st.columns([1.2, 0.8])
    
    with hero_col1:
        # 左侧：显示 徽章 + 标题 + Slogan + 描述
        st.markdown(f"""
        <div style="text-align: left; padding-top: 20px;">
            <div class="archetype-badge">ZEUS TRADING PROFILE • {mbti}</div>
            <h1 class="main-title-gradient" style="font-size: 3em; margin: 10px 0;">{archetype_name}</h1>
            <div style="font-size: 1.4em; font-style: italic; color: #60a5fa; margin-bottom: 20px; font-family: 'Georgia', serif; border-left: 4px solid #60a5fa; padding-left: 15px;">
            “{template.get('tagline', '')}”
            </div>
            <p style="color: #94a3b8; font-size: 1.1em; line-height: 1.6;">
            {template.get('cognitive', '')[:120]}... </p>
        </div>
        """, unsafe_allow_html=True)
    
    with hero_col2:
        # 右侧：显示人物插图
        # 注意：如果是本地图片，确保路径正确；如果是URL，Streamlit会自动加载
        try:
            # 使用 st.image 渲染，并应用自定义 CSS class
            # 注意：st.image 默认不支持直接加 class，我们用外层 div 包裹或者直接渲染
            st.markdown('<div class="hero-image-container">', unsafe_allow_html=True)
            st.image(image_path, use_container_width=True) 
            st.markdown('</div>', unsafe_allow_html=True)
        except Exception:
            # 如果找不到图片，显示占位符
            st.error(f"Image not found: {image_path}")

    # 3. 渲染下方的四个字母维度 (这部分保持宽屏展示)
    traits_html = build_traits_html(mbti)
    st.markdown(f"""
    <div style="margin-top: 30px; margin-bottom: 40px;">
        <div class="traits-grid">
            {traits_html}
        </div>
    </div>
    <div style="height: 1px; background: #334155; margin: 20px 0 40px 0;"></div>
    """, unsafe_allow_html=True)
    # -------------------------------------------------------
    # 核心仪表盘
    # -------------------------------------------------------
    c1, c2 = st.columns([1.3, 1])
    
    with c1:
        # 【修复点3】HTML 字符串顶格
        st.markdown(f"""
<div class="css-card" style="height: 100%;">
<h3 style="color: #fff; margin-top: 0; display: flex; align-items: center;">
<span style="margin-right: 10px;">🧠</span> 认知内核 (Cognitive Core)
</h3>
<div style="color: #cbd5e1; line-height: 1.7; font-size: 1em; text-align: justify; margin-bottom: 20px;">
{template['cognitive']}
</div>
<div style="padding: 15px; background: rgba(248, 113, 113, 0.1); border-left: 3px solid #f87171; border-radius: 4px;">
<strong style="color: #f87171; display: block; margin-bottom: 5px;">⚠️ 需要注意点 (Blindspot)</strong>
<span style="color: #e2e8f0; font-size: 0.95em; white-space: pre-line; line-height: 1.6;">{template['blindspot']}</span>
</div>
</div>
""", unsafe_allow_html=True)
        
    with c2:
        radar_html = get_radar_html(radar_scores)
        
        st.markdown(f"""
<div class="css-card" style="height: 100%;">
<h4 style="margin-top: 0; color: #fff; margin-bottom: 20px;">📊 交易员五维属性</h4>
{radar_html}
</div>
""", unsafe_allow_html=True)

    # -------------------------------------------------------
    # 深度详情 Tabs
    # -------------------------------------------------------
    st.markdown("<br>", unsafe_allow_html=True)
    
    tab1, tab2, tab3, tab4, tab5, tab6 = st.tabs([
    "⚔️ 战场策略 (Strategy)",
    "🧬 基因优势 (Alpha)",
    "🛠️ 装备环境 (Setup)",
    "🚀 进化路线 (Evolution)",
    "🧯 风控协议 (Risk)",
    "📝 复盘清单 (Review)"
    ])
    
    # --- Tab 1: 策略与市场 ---
    with tab1:
        tab1_html = f"""
<h3 style=\"color: #facc15; margin-top: 0;\">🌍 适配战场 (Markets)</h3>
<p style=\"color: #cbd5e1; background: rgba(15, 23, 42, 0.5); padding: 15px; border-radius: 8px; border: 1px solid #334155; white-space: pre-line; line-height: 1.6;\">
{template.get('markets', '全市场通用')}
</p>

<h3 style=\"color: #4ade80; margin-top: 25px;\">🎯 建议策略 (Playbook)</h3>
<p style=\"color: #cbd5e1; line-height: 1.6;\">{template.get('strategy', '趋势跟踪')}</p>

<div style=\"display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 25px;\">
  <div style=\"background: rgba(16, 185, 129, 0.1); padding: 20px; border-radius: 12px; border: 1px solid rgba(16, 185, 129, 0.2);\">
    <strong style=\"color: #34d399; font-size: 1.1em;\">✅ 胜利方程式 (Win Condition)</strong>
    <p style=\"font-size: 0.95em; color: #d1fae5; margin-top: 10px; line-height: 1.5;\">{template.get('win_condition', '顺势而为')}</p>
  </div>
  <div style=\"background: rgba(239, 68, 68, 0.1); padding: 20px; border-radius: 12px; border: 1px solid rgba(239, 68, 68, 0.2);\">
    <strong style=\"color: #f87171; font-size: 1.1em;\">💀 爆仓扳机 (Loss Trigger)</strong>
    <p style=\"font-size: 0.95em; color: #fee2e2; margin-top: 10px; line-height: 1.5;\">{template.get('loss_trigger', '逆势抗单')}</p>
  </div>
</div>
"""
        st.markdown(tab1_html, unsafe_allow_html=True)

    # --- Tab 2: 优势与弱点 ---
    with tab2:
        s_li = "".join([f"<li style='margin-bottom:8px; color:#cbd5e1;'>{s}</li>" for s in template.get('strengths', [])])
        w_li = "".join([f"<li style='margin-bottom:8px; color:#cbd5e1;'>{w}</li>" for w in template.get('weaknesses', [])])
        
        st.markdown(f"""
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
<div style="background: rgba(30, 41, 59, 0.5); padding: 20px; border-radius: 12px; border-top: 3px solid #4ade80;">
<h3 style="color: #4ade80; margin-top: 0; font-size: 1.2em;">⚡ 你的 Alpha (优势)</h3>
<ul style="padding-left: 20px; margin-bottom: 0;">{s_li}</ul>
</div>
<div style="background: rgba(30, 41, 59, 0.5); padding: 20px; border-radius: 12px; border-top: 3px solid #f87171;">
<h3 style="color: #f87171; margin-top: 0; font-size: 1.2em;">🥀 你的 Risk (弱点)</h3>
<ul style="padding-left: 20px; margin-bottom: 0;">{w_li}</ul>
</div>
</div>
<div style="margin-top: 20px; padding: 15px; background: linear-gradient(90deg, rgba(30,41,59,0.8) 0%, rgba(15,23,42,0.8) 100%); border: 1px solid #3b82f6; border-radius: 12px;">
<strong style="color: #60a5fa;">🤝 最佳互补拍档</strong>
<p style="color: #e2e8f0; margin-top: 5px; margin-bottom: 0;">{template.get('partners', '寻找风控官')}</p>
</div>
""", unsafe_allow_html=True)

    # --- Tab 3: 环境与工具 ---
    with tab3:
        # 【修复点5】列表推导式中的 HTML 字符串也必须顶格
        tools_html = "".join([f"""<span style='display:inline-block; background:#0f172a; padding:6px 14px; border-radius:20px; border:1px solid #334155; margin:0 8px 8px 0; font-size:0.9em; color:#94a3b8; transition: all 0.2s;'>
🛠️ {t}
</span>""" for t in template.get('tools', [])])
        
        st.markdown(f"""
<h3 style="color: #e2e8f0; margin-top: 0;">🖥️ 物理战场配置 (Desk Setup)</h3>
<div style="background: #0f172a; padding: 25px; border-radius: 12px; margin-bottom: 25px; white-space: pre-line; color: #cbd5e1; line-height: 1.8; border: 1px solid #1e293b;">
{template.get('desk_setup', '保持整洁，减少干扰。')}
</div>

<h3 style="color: #e2e8f0;">🧰 推荐武器库 (Tools)</h3>
<div style="margin-top: 15px;">
{tools_html}
</div>
""", unsafe_allow_html=True)

    # --- Tab 4: 进化路线 ---
    with tab4:
        evo = template.get('evolution', {'lvl1': 'Loading...', 'lvl2': 'Loading...', 'lvl3': 'Loading...'})
        st.markdown(f"""
<div style="position: relative; padding-left: 20px; border-left: 2px solid #334155; margin-left: 10px;">

<div style="margin-bottom: 40px; position: relative;">
<div style="position: absolute; left: -26px; top: 0; width: 10px; height: 10px; background: #94a3b8; border-radius: 50%;"></div>
<div style="font-size: 0.8em; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px;">Level 1 • 觉醒前</div>
<strong style="color: #cbd5e1; font-size: 1.2em;">🐣 新手陷阱</strong>
<p style="color: #64748b; margin-top: 8px; line-height: 1.6;">{evo.get('lvl1')}</p>
</div>

<div style="margin-bottom: 40px; position: relative;">
<div style="position: absolute; left: -26px; top: 0; width: 10px; height: 10px; background: #60a5fa; border-radius: 50%; box-shadow: 0 0 10px #60a5fa;"></div>
<div style="font-size: 0.8em; color: #60a5fa; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px;">Level 2 • 蜕变期</div>
<strong style="color: #fff; font-size: 1.2em;">🦋 规则建立</strong>
<p style="color: #94a3b8; margin-top: 8px; line-height: 1.6;">{evo.get('lvl2')}</p>
</div>

<div style="position: relative;">
<div style="position: absolute; left: -26px; top: 0; width: 10px; height: 10px; background: #4ade80; border-radius: 50%; box-shadow: 0 0 15px #4ade80;"></div>
<div style="font-size: 0.8em; color: #4ade80; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px;">Level 3 • 终极形态</div>
<strong style="color: #4ade80; font-size: 1.2em;">🦁 顶级猎手</strong>
<p style="color: #cbd5e1; margin-top: 8px; line-height: 1.6;">{evo.get('lvl3')}</p>
</div>
</div>
""", unsafe_allow_html=True)

    with tab5:
        st.markdown(f"<div class='css-card' style='white-space: pre-line;'>{addon['risk_protocol']}\n\n{addon['execution_sop']}</div>", unsafe_allow_html=True)

    with tab6:
        st.markdown(f"<div class='css-card' style='white-space: pre-line;'>{addon['review_checklist']}</div>", unsafe_allow_html=True)
    
    # -------------------------------------------------------
    # 底部行动区
    # -------------------------------------------------------
    st.divider()
    st.markdown(f"""
<div style='text-align: center; margin-bottom: 30px;'>
<h3 style='color: white; margin-bottom: 10px;'>🚀 Ready to Upgrade?</h3>
<p style='color: #94a3b8; font-size: 0.95em;'>
加入 Zeuspace Pro 核心圈子，获取属于 <strong>{mbti}</strong> 的每日量化策略信号。
</p>
</div>
""", unsafe_allow_html=True)
    
    col1, col2 = st.columns(2)
    with col1:
        if st.button("联系我们 👨‍🏫", type="primary", use_container_width=True):
            st.session_state.step = 'contact_sales'
            st.rerun()
    with col2:
        if st.button("🔄 重置测试 (Reset)", type="secondary", use_container_width=True):
            reset_test()
            st.rerun()
            
    st.markdown("<br>", unsafe_allow_html=True)
    st.markdown("""
<div style='display: grid; grid-template-columns: 1fr 1fr; gap: 15px;'>
<a href="#" class="social-btn social-linkedin"><span>🔗 LinkedIn Profile</span></a>
<a href="#" class="social-btn social-twitter"><span>🐦 Twitter Insight</span></a>
</div>
<div style='text-align:center; margin-top:30px; color:#475569; font-size:0.8em;'>
Zeuspace Neural Engine v2.4 • Powered by Behavioral Finance
</div>
""", unsafe_allow_html=True)
    
    st.markdown("<br>", unsafe_allow_html=True)
    if st.button("← 返回报告页面"):
        st.session_state.step = 'result'
        st.rerun()

# --- 联系页 (去敏化，合规版) ---
elif st.session_state.step == 'contact_sales':
    st.markdown("""
    <div style='text-align: center; padding: 40px 0;'>
        <div style='font-size: 3em; margin-bottom: 20px;'>💎</div>
        <h1 style='color: white;'>Zeuspace Professional Network</h1>
        <p style='color: #cbd5e1; font-size: 1.1em; max-width: 600px; margin: 0 auto 40px auto;'>
            感谢您的关注。作为 <strong>{type}</strong> 类型的交易者，您可能需要更精准的市场数据与工具支持。<br>
            欢迎通过以下官方渠道与我们建立联系。
        </p>
    </div>
    """.format(type=st.session_state.mbti_result), unsafe_allow_html=True)
    
    # 社交媒体大卡片
    st.markdown("""
    <div style='background: rgba(30, 41, 59, 0.6); padding: 30px; border-radius: 20px; border: 1px solid #334155; max-width: 500px; margin: 0 auto;'>
        <div style='display: flex; flex-direction: column; gap: 15px;'>
            <a href="https://www.linkedin.com/company/zeuspace-group/" target="_blank" style='text-decoration: none;'>
                <div style='background: #0077b5; color: white; padding: 18px; border-radius: 12px; text-align: center; font-weight: bold; transition: opacity 0.2s;'>
                    💼 Connect on LinkedIn
                    <div style='font-size: 0.8em; opacity: 0.9; font-weight: normal; margin-top: 5px;'>适合商务合作与专业咨询</div>
                </div>
            </a>
            <a href="https://x.com/ZeuspaceGroup" target="_blank" style='text-decoration: none;'>
                <div style='background: #000000; color: white; padding: 18px; border-radius: 12px; text-align: center; font-weight: bold; border: 1px solid #333; transition: opacity 0.2s;'>
                    🐦 Follow on X (Twitter)
                    <div style='font-size: 0.8em; opacity: 0.9; font-weight: normal; margin-top: 5px;'>获取实时市场观点与动态</div>
                </div>
            </a>
        </div>
        <p style='text-align: center; margin-top: 20px; color: #64748b; font-size: 0.8em;'>
            Disclaimer: Zeuspace is a technology and research provider. We do not provide financial advice.
        </p>
    </div>
    """, unsafe_allow_html=True)
    
    st.markdown("<br>", unsafe_allow_html=True)
    if st.button("← 返回报告页面"):
        st.session_state.step = 'result'
        st.rerun()
